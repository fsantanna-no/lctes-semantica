\appendix
\section{Proofs}
\label{sec.proofs}

\subsection*{Determinism}


\begin{lemma}\label{lem.det-out}
  If~$\delta\out\delta_1$ and~$\delta\out\delta_2$ then~$\delta_1=\delta_2$.
\end{lemma}
\begin{proof}
  The lemma is vacuously true if~$\delta$ cannot be advanced by~$\out$
  transitions.  Suppose that is not the case and let~$\delta=\<p,n,e>$,
  $\delta_1=\<p_1,n_1,e_1>$ and~$\delta_2=\<p_2,n_2,e_2>$.  Then, there are
  two possibilities.
  \begin{case}
    $e\ne\nil$.  Both transitions are applications of~\R{push}.
    Hence~$p_1=p_2=\bcast(p,e)$, $n_1=n_2=n+1$, and~$e_1=e_2=\nil$.
  \end{case}
  \begin{case}
    $e=\nil$.  Both transitions are applications of~\R{pop}.
    Hence~$p_1=p_2=p$, $n_1=n_2=n-1$, and~$e_1=e_2=\nil$.\qedhere
  \end{case}
\end{proof}


\begin{theorem}\label{thm.det-out-pop-n}
  If~$\delta\out[n]\delta_1$ and~$\delta\out[n]\delta_2$
  then~$\delta_1=\delta_2$.
\end{theorem}
\begin{proof}
  By induction on~$n$.
  %%
  The theorem is trivially true for~$n=0$ and follows directly from
  Lemma~\ref{lem.det-out} for~$n=1$.  (The theorem is vacuously true
  for~$\outpush$ transitions if~$n>1$ since, by definition,
  $\outpush$~transitions cannot be applied more than once in a row and
  cannot occur after a~$\outpop$ transition.)
  %%
  Suppose~$\delta\out[1]\delta_1'\out[n-1]\delta_1$
  and~$\delta\out[1]\delta_2'\out[n-1]\delta_2$, for some~$n>1$
  and~$\delta_1'$, $\delta_2'\in\Delta$.
  %%
  By Lemma~\ref{lem.det-out}, $\delta_1'=\delta_2'$.  By the induction
  hypothesis, $\delta_1=\delta_2$.\qedhere
\end{proof}


\begin{lemma}\label{lem.det-nst}
  If~$\delta\nst\delta_1$ and~$\delta\nst\delta_2$ then~$\delta_1=\delta_2$.
\end{lemma}
\begin{proof}
  By induction on the structure of~$\nst$ derivations.  The lemma is
  vacuously true if~$\delta$ cannot be advanced by~$\nst$ transitions.
  Suppose that is not the case and let~$\delta=\<p,n,e>$,
  $\delta_1=\<p_1,n_1,e_1>$ and~$\delta_2=\<p_2,n_2,e_2>$.  Then, by the
  hypothesis of the lemma, there are derivations~$\pi_1$ and~$\pi_2$ such
  that
  \begin{align*}
    \pi_1&\Vdash\<p,n,e>\nst\<p_1,n_1,e_1>\\
    \pi_2&\Vdash\<p,n,e>\nst\<p_2,n_2,e_2>
  \end{align*}
  i.e., the conclusion of~$\pi_1$ is~$\<p,n,e>\nst\<p_1,n_1,e_1>$ and the
  conclusion of~$\pi_2$ is~$\<p,n,e>\nst\<p_2,n_2,e_2>$.

  By definition of~$\nst$, we have that~$e=\nil$ and $n_1=n_2=n$.  It
  remains to be shown that~$p_1=p_2$ and~$e_1=e_2$.

  Depending on the structure of program~$p$, the following~11 cases are
  possible.  (Note that~$p$ cannot be an~$\ceu{\AwaitExt}$,
  $\ceu{\AwaitInt}$, $\ceu{\Break}$, $\ceu{\Every}$, $\ceu{\Fin}$,
  or~$\ceu{\Nop}$ expression as there are no~$\nst$ rules to transition such
  programs.)

  \begin{case}
    $p=\ceu{\Mem(\Id)}$.
    %%
    Then derivations~$\pi_1$ and~$\pi_2$ are instances of rule~\R{mem},
    i.e., their conclusions are obtained by an application of this rule.
    Hence~$p_1=p_2=\ceu{\Nop}$ and~$e_1=e_2=\nil$.
  \end{case}

  \begin{case}
    $p=\ceu{\EmitInt(e')}$.
    %%
    Then~$\pi_1$ and~$\pi_2$ are instances of~\R{emit-int}.
    Hence~$p_1=p_2=\ceu{\CanRun(n)}$ and~$e_1=e_2=e'$.
  \end{case}

  \begin{case}
    $p=\ceu{\CanRun(n)}$.
    %%
    Then~$\pi_1$ and~$\pi_2$ are instances of~\R{can-run}.
    Hence~$p_1=p_2=\ceu{\Nop}$ and~$e_1=e_2=\nil$.
  \end{case}

  \begin{case}
    $p=\ceu{\IfElse{\Mem(\Id)}{p'}{p''}}$.
    %%
    There are two subcases.
    \begin{subcase}
      $\eval(\ceu{\Mem(\Id)})$~is true.
      %%
      Then~$\pi_1$ and~$\pi_2$ are instances of~\R{if-true}.
      Hence~$p_1=p_2=p'$ and~$e_1=e_2=\nil$.
    \end{subcase}
    \begin{subcase}
      $\eval(\ceu{\Mem(\Id)})$ is false.
      %%
      Then~$\pi_1$ and~$\pi_2$ are instances of~\R{if-false}.
      Hence~$p_1=p_2=p''$ and~$e_1=e_2=\nil$.
    \end{subcase}
  \end{case}

  \begin{case}
    $p=\ceu{p';\,p''}$.
    %%
    There are three subcases.
    \begin{subcase}
      $p'=\ceu{\Nop}$.
      %%
      Then~$\pi_1$ and~$\pi_2$ are instances of~\R{seq-nop}.
      Hence~$p_1=p_2=p''$ and~$e_1=e_2=\nil$.
    \end{subcase}
    \begin{subcase}
      $p'=\ceu{\Break}$.
      %%
      Then~$\pi_1$ and~$\pi_2$ are instances of~\R{seq-brk}.
      Hence~$p_1=p_2=\ceu{\Break}$ and~$e_1=e_2=\nil$.
    \end{subcase}
    \begin{subcase}
      $p'\ne\ceu{\Nop},\ceu{\Break}$.
      %%
      Then~$\pi_1$ and~$\pi_2$ are instances of~\R{seq-adv}.
      Thus there are derivations~$\pi_1'$ and~$\pi_2'$ such that
      \begin{align*}
        \pi_1'&\Vdash\<p',n,\nil>\nst\<p_1',n,e_1'>\\
        \pi_2'&\Vdash\<p',n,\nil>\nst\<p_2',n,e_2'>
      \end{align*}
      for some~$p_1',p_2'\in\P$ and~$e_1',e_2'\in\E$.  By the induction
      hypothesis, $p_1'=p_2'$ and~$e_1'=e_2'$.
      Hence~$p_1=\ceu{p_1';p''}=\ceu{p_2';p''}=p_2$ and~$e_1=e_1'=e_2'=e_2$.
    \end{subcase}
  \end{case}

  \begin{case}
    $p=\ceu{\Loop{p'}}$.
    %%
    Then~$\pi_1$ and~$\pi_2$ are instances of~\R{loop-expd}.
    Hence~$p_1=p_2=\ceu{p'\AtLoop{p'}}$ and~$e_1=e_2=\nil$.
  \end{case}

  \begin{case}
    $p=\ceu{p'\AtLoop{p''}}$.  There are three subcases.
    \begin{subcase}
      $p'=\ceu{\Nop}$.
      %%
      Then~$\pi_1$ and~$\pi_2$ are instances of~\R{loop-nop}.
      Hence~$p_1=p_2=\ceu{\Loop{p''}}$ and~$e_1=e_2=\nil$.
    \end{subcase}
    \begin{subcase}
      $p'=\ceu{\Break}$.
      %%
      Then~$\pi_1$ and~$\pi_2$ are instances of~\R{loop-brk}.
      Hence~$p_1=p_2=\ceu{\Nop}$ and~$e_1=e_2=\nil$.
    \end{subcase}
    \begin{subcase}
      $p'\ne\ceu{\Nop},\ceu{\Break}$.
      %%
      Then~$\pi_1$ and~$\pi_2$ are instances of~\R{loop-adv}.
      Thus there are derivations~$\pi_1'$ and~$\pi_2'$ such that
      \begin{align*}
        \pi_1'&\Vdash\<p',n,\nil>\nst\<p_1',n,e_1'>\\
        \pi_2'&\Vdash\<p',n,\nil>\nst\<p_2',n,e_2'>
      \end{align*}
      for some~$p_1',p_2'\in\P$ and~$e_1',e_2'\in\E$.  By the induction
      hypothesis, $p_1'=p_2'$ and~$e_1'=e_2'$.
      Hence~$p_1=\ceu{p_1'\AtLoop{p''}}=\ceu{p_2'\AtLoop{p''}}=p_2$
      and~$e_1=e_1'=e_2'=e_2$.
    \end{subcase}
  \end{case}

  \begin{case}
    $p=\ceu{p'\And{p''}}$.
    %%
    Then~$\pi_1$ and~$\pi_2$ are instances of~\R{and-expd}.
    Hence~$p_1=p_2=\ceu{{p'}\AtAnd{(\CanRun(n);\,p'')}}$ and~$e_1=e_2=\nil$.
  \end{case}

  \begin{case}
    $p=\ceu{p'\AtAnd{p''}}$.  There are two subcases.
    \begin{subcase}
      $\isblocked(p',n)$~is false.  There are three subcases.
      \begin{subsubcase}
        $p'=\ceu{\Nop}$.
        %%
        Then~$\pi_1$ and~$\pi_2$ are instances of~\R{and-nop1}.
        Hence~$p_1=p_2=p''$ and~$e_1=e_2\nil$.
      \end{subsubcase}
      \begin{subsubcase}
        \label{lem.det-nst.and-brk1}
        $p'=\ceu{\Break}$.
        %%
        Then~$\pi_1$ and~$\pi_2$ are instances of~\R{and-brk1}.
        Hence~$p_1=p_2=\ceu{\clear(p'');\Break}$ and~$e_1=e_2\nil$.
      \end{subsubcase}
      \begin{subsubcase}\label{lem.det-nst.and-adv1}
        $p'\ne\ceu{\Nop},\ceu{\Break}$.
        %%
        Then~$\pi_1$ and~$\pi_2$ are instances of~\R{and-adv1}.
        Thus there are derivations~$\pi_1'$ and~$\pi_2'$ such that
        \begin{align*}
          \pi_1'&\Vdash\<p',n,\nil>\nst\<p_1',n,e_1'>\\
          \pi_2'&\Vdash\<p',n,\nil>\nst\<p_2',n,e_2'>
        \end{align*}
        for some~$p_1',p_2'\in\P$ and~$e_1',e_2'\in\E$.  By the induction
        hypothesis, $p_1'=p_2'$ and~$e_1'=e_2'$.
        Hence~$p_1=\ceu{{p_1'}\And{p''}}=\ceu{{p_2'}\And{p''}}=p_2$
        and~$e_1=e_1'=e_2'=e_2$.
      \end{subsubcase}
    \end{subcase}
    \begin{subcase}
      $\isblocked(p',n)$~is true.  There are three subcases.
      \begin{subsubcase}
        $p''=\ceu{\Nop}$.
        %%
        Then~$\pi_1$ and~$\pi_2$ are instances of~\R{and-nop2}.
        Hence~$p_1=p_2=p'$ and~$e_1=e_2\nil$.
      \end{subsubcase}
      \begin{subsubcase}\label{lem.det-nst.and-brk2}
        $p''=\ceu{\Break}$.
        %%
        Then~$\pi_1$ and~$\pi_2$ are instances of~\R{and-brk2}.
        Hence~$p_1=p_2=\ceu{\clear(p');\Break}$ and~$e_1=e_2=\nil$.
      \end{subsubcase}
      \begin{subsubcase}\label{lem.det-nst.and-adv2}
        $p''\ne\ceu{\Nop},\ceu{\Break}$.
        %%
        Then~$\pi_1$ and~$\pi_2$ are instances of~\R{and-adv2}.  Thus there
        are derivations~$\pi_1''$ and~$\pi_2''$ such that
        \begin{align*}
          \pi_1''&\Vdash\<p'',n,\nil>\nst\<p_1'',n,e_1''>\\
          \pi_2''&\Vdash\<p'',n,\nil>\nst\<p_2'',n,e_2''>
        \end{align*}
        for some~$p_1'',p_2''\in\P$ and~$e_1'',e_2''\in\E$.  By the
        induction hypothesis, $p_1''=p_2''$ and~$e_1''=e_2''$.
        Hence~$p_1=\ceu{{p'}\And{p_1''}}=\ceu{{p'}\And{p_2''}}=p_2$
        and~$e_1=e_1''=e_2''=e_2$.
      \end{subsubcase}
    \end{subcase}
  \end{case}

  \begin{case}
    $p=\ceu{p'\Or{p''}}$.
    %%
    Then~$\pi_1$ and~$\pi_2$ are instances of~\R{or-expd}.
    Hence~$p_1=p_2=\ceu{{p'}\AtOr{(\CanRun(n);\,p'')}}$ and~$e_1=e_2=\nil$.
  \end{case}

  \begin{case}
    $p=\ceu{p'\AtOr{p''}}$.  There are two subcases.
    \begin{subcase}
      $\isblocked(p',n)$~is false.  There are three subcases.
      \begin{subsubcase}
        $p'=\ceu{\Nop}$.
        %%
        Then~$\pi_1$ and~$\pi_2$ are instances of~\R{or-nop1}.
        Hence~$p_1=p_2=\clear(p'')$ and~$e_1=e_2=\nil$.
      \end{subsubcase}
      \begin{subsubcase}
        $p'=\ceu{\Break}$.
        %%
        Similar to Case~\ref{lem.det-nst.and-brk1}.
      \end{subsubcase}
      \begin{subsubcase}
        $p'\ne\ceu{\Nop},\ceu{\Break}$.
        %%
        Similar to Case~\ref{lem.det-nst.and-adv1}.
      \end{subsubcase}
    \end{subcase}
    \begin{subcase}
      $\isblocked(p',n)$~is true.  There are three subcases.
      \begin{subsubcase}
        $p''=\ceu{\Nop}$.
        %%
        Then~$\pi_1$ and~$\pi_2$ are instances of~\R{or-nop1}.
        Hence~$p_1=p_2=\clear(p')$ and~$e_1=e_2=\nil$.
      \end{subsubcase}
      \begin{subsubcase}
        $p''=\ceu{\Break}$.
        %%
        Similar to Case~\ref{lem.det-nst.and-brk2}.
      \end{subsubcase}
      \begin{subsubcase}
        $p''\ne\ceu{\Nop},\ceu{\Break}$.
        %%
        Similar to Case~\ref{lem.det-nst.and-adv2}.
        %%
        \qedhere
      \end{subsubcase}
    \end{subcase}
  \end{case}
\end{proof}


\begin{theorem}\label{thm.det-nst-n}
  If~$\delta\nst[n]\delta_1$ and~$\delta\nst[n]\delta_2$
  then~$\delta_1=\delta_2$.
\end{theorem}
\begin{proof}
  Similar to the proof of Theorem~\ref{thm.det-out-pop-n}.
\end{proof}

\subsection*{Termination}


\begin{definition}\label{def.Hnst}
  A description~$\delta=\<p,n,e>$ is \emph{nested-irre\-ducible}
  iff~$e\ne\nil$ or~$p=\ceu{\Nop},\ceu{\Break}$ or~$\isblocked(p,n)$~is
  true.  Nested-irreducible descriptions serve as normal forms for~$\nst$
  transitions: they embody the result of an exhaustive number of~$\nst$
  applications.  We will write~$\delta_\Hnst$ to indicate that
  description~$\delta$ is nested-irreducible.
\end{definition}

The next lemma justifies the use of qualifier ``irreducible'' in
Definition~\ref{def.Hnst}.


\begin{lemma}\label{lem.irr-nst-n}
  If~$\delta\nst[n]\delta_\Hnst'$ then, for all~$i\ne{n}$, there is
  no~$\delta_\Hnst''$ such that~$\delta\nst[i]\delta''_\Hnst$.
\end{lemma}
\begin{proof}
  By contradiction on the hypothesis that there is such~$i$.
  %%
  Let~$\delta\nst[n]\delta'_\Hnst$, for some~$n\ge0$.
  There are two cases.
  \begin{case}\label{lem.irr-nst-n-case1}
    Suppose there are~$i>n$ and~$\delta''_\Hnst$ such
    that~$\delta\nst[i]\delta''$.
    %%
    Then, by definition of~$\nst[i]$,
    \begin{equation}\label{lem.irr-nst-n-eq1}
      \delta\nst[n]\delta'\nst[n+1]\delta_1'\nst[n+2]\cdots\nst[i]\delta''.
    \end{equation}
    Since~$\delta'=\<p',n,e'>$ is nested-irreducible, $e'=\nil$
    or~$p=\ceu{\Nop},\ceu{\Break}$ or~$\isblocked(p',n)$.  In any of these
    cases, by the definition of~$\nst$, there is no~$\delta_1'$ such
    that~$\delta'\nst[1]\delta_1'$, which
    contradicts~\eqref{lem.irr-nst-n-eq1}.  Therefore, no such~$i$ can
    exist.
  \end{case}
  \begin{case}
    Suppose there are~$i<n$ and~$\delta''_\Hnst$ such
    that~$\delta\nst[i]\delta''$.  Then, since~$n>i$, by
    Case~\ref{lem.irr-nst-n-case1}, $\delta'$~cannot exist, which is absurd.
    Therefore, the assumption that there is such~$i$ is false.\qedhere
  \end{case}
\end{proof}

The next lemma establishes some basic properties of sequences of~$\nst$
transitions.


\begin{lemma}\label{lem.props-nst-n}
  If~$\<p_1,n,e>\nst[n]\<p_1',n,e'>$ then, for any~$p_2$:
  \begin{enumerate}[(a)]
  \item\label{lem.props-nst-n.a}
    $\<\ceu{p_1;\,p_2},n,e>\nst[n]\<p_1';p_2,n,e'>$;
    %%
  \item\label{lem.props-nst-n.b}
    $\<\ceu{p_1\AtLoop{p_2}},n,e>\nst[n]\<\ceu{p_1'\AtLoop{p_2}},n,e'>$;
    %%
  \item\label{lem.props-nst-n.c}
    $\<\ceu{{p_1}\AtAnd{p_2}},n,e>\nst[n]\<\ceu{{p_1'}\AtAnd{p_2}},n,e'>$;
    %%
  \item\label{lem.props-nst-n.d}
    $\<\ceu{{p_1}\AtOr{p_2}},n,e>\nst[n]\<\ceu{{p_1}'\AtOr{p_2}},n,e'>$.
  \end{enumerate}
  If~$\<p_2,n,e>\nst[n]\<p_2',n,e'>$, for any~$p_1$ such
  that~$\isblocked(p_1,n)$:
  \begin{enumerate}[(a)]
    \setcounter{enumi}{4}
  \item\label{lem.props-nst-n.e}
    $\<\ceu{{p_1}\AtAnd{p_2}},n,e>\nst[n]\<\ceu{{p_1}\AtAnd{p_2'}},n,e'>$;
    %%
  \item\label{lem.props-nst-n.f}
    $\<\ceu{{p_1}\AtOr{p_2}},n,e>\nst[n]\<\ceu{{p_1}\AtOr{p_2'}},n,e'>$.
  \end{enumerate}
\end{lemma}
\begin{proof}
  By induction on~$n$.
  %%
  \begin{enumerate}[(a)]
  \item The lemma is trivially true for~$n=0$, as~$p_1=p_1'$, and follows
    directly from~\R{seq-adv} for~$n=1$.  Suppose
    \begin{equation}
      \label{lem.props-nst-n.a.eq1}
      \<p_1,n,e>\nst[1]\<p_1'',n,e''>\nst[n-1]\<p_1',n,e'>\,,
    \end{equation}
    for some~$n>1$.  Then~$\<p_1'',n,e''>$ is not nested-irreducible, i.e.,
    $e=\nil$ and~$p\ne{\ceu{\Nop},\ceu{\Break}}$ and~$\isblocked(p_1'',n)$
    is false.  By~\eqref{lem.props-nst-n.a.eq1} and by~\R{seq-adv},
    \begin{equation}
      \label{lem.props-nst-n.a.eq2}
      \<\ceu{p_1;\,p_2},n,e>\nst[1]\<\ceu{p_1'';\,p_2},n,e''>\,.
    \end{equation}
    From~\eqref{lem.props-nst-n.a.eq1}, by the induction hypothesis,
    \begin{equation}
      \label{lem.props-nst-n.a.eq3}
      \<\ceu{p_1'';\,p_2},n,e''>\nst[n-1]\<\ceu{p_1';\,p_2},n,e'>\,.
    \end{equation}
    From~\eqref{lem.props-nst-n.a.eq2} and~\eqref{lem.props-nst-n.a.eq3},
    \[
      \<\ceu{p_1;\,p_2},n,e>\nst[n]\<\ceu{p_1';\,p_2},n,e'>\,.
    \]

  \item Similar to Case~\eqref{lem.props-nst-n.a}.
    %%
    % The lemma is trivially true for~$n=0$, as~$p_1=p_1'$, and follows
    % directly from~\R{loop-adv} for~$n=1$.  Suppose
    % \begin{equation}
    %   \label{lem.props-nst-n.b.eq1}
    %   \<p_1,n,e>\nst[1]\<p_1'',n,e''>\nst[n-1]\<p_1',n,e'>\,,
    % \end{equation}
    % for some~$n>1$.  Then~$\<p_1'',n,e''>$ is not nested-irreducible.
    % By~\eqref{lem.props-nst-n.b.eq1} and by~\R{loop-adv},
    % \begin{equation}
    %   \label{lem.props-nst-n.b.eq2}
    %   \<\ceu{p_1\AtLoop{p_2}},n,e>\nst[1]\<\ceu{p_1''\Loop{p_2}},n,e''>\,.
    % \end{equation}
    % From~\eqref{lem.props-nst-n.b.eq1}, by the induction hypothesis,
    % \begin{equation}
    %   \label{lem.props-nst-n.b.eq3}
    %   \<\ceu{p_1''\AtLoop{p_2}},n,e''>
    %   \nst[n-1]\<\ceu{p_1'\AtLoop{p_2}},n,e'>\,.
    % \end{equation}
    % From~\eqref{lem.props-nst-n.b.eq2} and~\eqref{lem.props-nst-n.b.eq3},
    % \[
    %   \<\ceu{p_1\AtLoop{p_2}},n,e>\nst[n]\<\ceu{p_1'\AtLoop{p_2}},n,e'>\,.
    % \]
    %%

  \item Similar to Case~\eqref{lem.props-nst-n.a}.
    %%
    % The lemma is trivially true for~$n=0$, as~$p_1=p_1'$, and follows
    % directly from~\R{and-adv1} for~$n=1$.  Suppose
    % \begin{equation}
    %   \label{lem.props-nst-n.c.eq1}
    %   \<p_1,n,e>\nst[1]\<p_1'',n,e''>\nst[n-1]\<p_1',n,e'>\,,
    % \end{equation}
    % for some~$n>1$.  Then~$\<p_1'',n,e''>$ is not nested-irreducible.
    % By~\eqref{lem.props-nst-n.c.eq1} and by~\R{and-adv1},
    % \begin{equation}
    %   \label{lem.props-nst-n.c.eq2}
    %   \<\ceu{{p_1}\AtAnd{p_2}},n,e>
    %   \nst[1]\<\ceu{{p_1}''\AtAnd{p_2}},n,e''>\,.
    % \end{equation}
    % From~\eqref{lem.props-nst-n.c.eq1}, by the induction hypothesis,
    % \begin{equation}
    %   \label{lem.props-nst-n.a.eq3}
    %   \<\ceu{{p_1''}\AtAnd{p_2}},n,e''>
    %   \nst[n-1]\<\ceu{{p_1'}\AtAnd{p_2}},n,e'>\,.
    % \end{equation}
    % From~\eqref{lem.props-nst-n.c.eq2} and~\eqref{lem.props-nst-n.c.eq3},
    % \[
    %   \<\ceu{{p_1}\AtAnd{p_2}},n,e>
    %   \nst[n]\<\ceu{{p_1'}\AtAnd{p_2}},n,e'>\,.
    % \]
    %%

  \item Similar to Case~\eqref{lem.props-nst-n.a}.
    %%
    % The lemma is trivially true for~$n=0$, as~$p_1=p_1'$, and follows
    % directly from~\R{or-adv1} for~$n=1$.  Suppose
    % \begin{equation}
    %   \label{lem.props-nst-n.d.eq1}
    %   \<p_1,n,e>\nst[1]\<p_1'',n,e''>\nst[n-1]\<p_1',n,e'>\,,
    % \end{equation}
    % for some~$n>1$.  Then~$\<p_1'',n,e''>$ is not nested-irreducible.
    % By~\eqref{lem.props-nst-n.d.eq1} and by~\R{or-adv1},
    % \begin{equation}
    %   \label{lem.props-nst-n.d.eq2}
    %   \<\ceu{{p_1}\AtOr{p_2}},n,e>
    %   \nst[1]\<\ceu{{p_1}''\AtOr{p_2}},n,e''>\,.
    % \end{equation}
    % From~\eqref{lem.props-nst-n.d.eq1}, by the induction hypothesis,
    % \begin{equation}
    %   \label{lem.props-nst-n.a.eq3}
    %   \<\ceu{{p_1''}\AtOr{p_2}},n,e''>
    %   \nst[n-1]\<\ceu{{p_1'}\AtOr{p_2}},n,e'>\,.
    % \end{equation}
    % From~\eqref{lem.props-nst-n.d.eq2} and~\eqref{lem.props-nst-n.d.eq3},
    % \[
    %   \<\ceu{{p_1}\AtOr{p_2}},n,e>
    %   \nst[n]\<\ceu{{p_1'}\AtOr{p_2}},n,e'>\,.
    % \]
    %%

  \item The lemma is trivially true for~$n=0$, as~$p_2=p_2'$, and follows
    directly from~\R{and-adv2} for~$n=1$.  Suppose
    \begin{equation}
      \label{lem.props-nst-n.e.eq1}
      \<p_2,n,e>\nst[1]\<p_2'',n,e''>\nst[n-1]\<p_2',n,e'>\,,
    \end{equation}
    for some~$n>1$.  Then~$\<p_2'',n,e''>$ is not nested-irreducible.
    By~\eqref{lem.props-nst-n.e.eq1} and by~\R{and-adv2},
    \begin{equation}
      \label{lem.props-nst-n.e.eq2}
      \<\ceu{{p_1}\AtAnd{p_2}},n,e>
      \nst[1]\<\ceu{{p_1}\AtAnd{p_2''}},n,e''>\,.
    \end{equation}
    From~\eqref{lem.props-nst-n.e.eq1}, by the induction hypothesis,
    \begin{equation}
      \label{lem.props-nst-n.e.eq3}
      \<\ceu{{p_1}\AtAnd{p_2''}},n,e''>
      \nst[n-1]\<\ceu{{p_1}\AtOr{p_2'}},n,e'>\,.
    \end{equation}
    From~\eqref{lem.props-nst-n.e.eq2} and~\eqref{lem.props-nst-n.e.eq3},
    \[
      \<\ceu{{p_1}\AtAnd{p_2}},n,e>
      \nst[n]\<\ceu{{p_1}\AtAnd{p_2'}},n,e'>\,.
    \]

  \item Similar to Case~\eqref{lem.props-nst-n.e}.\qedhere
  \end{enumerate}
\end{proof}

The syntactic restrictions discussed in Section~\ref{?}, regarding the body
of~$\ceu{\Fin}$ and~$\ceu{\Loop}$ expressions, are formalized by the
following assumptions.

\begin{assumption}\label{ass.term-nst-fin}
  If~$\delta=\<\ceu{\clear(p)},n,\nil>$ then there is a
  description~$\delta'=\<\ceu{\Nop},n,\nil>$ such
  that~$\delta\nst[*]\delta'$.
\end{assumption}

\begin{assumption}\label{ass.term-nst-loop}
  If~$\delta=\<\ceu{\Loop{p}},n,\nil>$ then there is a
  description~$\delta'=\<p',n,e>$ such that~$\delta\nst[*]\delta'$ where
  either~$p'=\ceu{{\Break}\AtLoop{p}}$ or~$\isblockedext(p',n)$.
\end{assumption}


\begin{theorem}\label{thm.term-nst-*}
  For any~$\delta$ there is a~$\delta'_\Hnst$ such
  that~$\delta\nst[*]\delta'_\Hnst$.
\end{theorem}
\begin{proof}
  By induction on the structure of programs.
  %%
  Let~$\delta=\<p,n,\nil>$.  The theorem is trivially true if~$\delta$ is
  nested-irreducible, as by definition~$\delta\nst[0]\delta$.  Suppose that
  is not the case.  Then, depending on the structure of~$p$, there are~11
  possibilities.  In each one of them, we show that such~$\delta'_\Hnst$
  indeed exists.
  \begin{case}
    $p=\ceu{\Mem(\Id)}$.
    %%
    Then, by~\R{mem},
    \[
      \<\ceu{\Mem(\Id)},n,\nil>\nst[1]\<\ceu{\Nop},n,\nil>_\Hnst\,.
    \]
  \end{case}

  \begin{case}
    $p=\ceu{\EmitInt(e)}$.
    %%
    Then, by~\R{emit-int},
    \[
      \<\ceu{\EmitInt(e)},n,\nil>\nst[1]\<\ceu{\CanRun(n)},n,e>_\Hnst\,.
    \]
  \end{case}

  \begin{case}
    $p=\ceu{\CanRun(n)}$.
    %%
    Then, by~\R{can-run},
    \[
      \<\ceu{\CanRun(n)},n,\nil>\nst[1]\<\ceu{\Nop},n,\nil>_\Hnst\,.
    \]
  \end{case}

  \begin{case}
    $p=\ceu{\IfElse{\Mem(\Id)}{p'}{p''}}$.
    %%
    There are two subcases.
    \begin{subcase}
      $\eval(\ceu{\Mem(\Id)})$~is true.
      %%
      Then, by~\R{if-true} and by the induction hypothesis, there is
      a~$\delta'$ such that
      \begin{align*}
        \<\ceu{\IfElse{\Mem(\Id)}{p'}{p''}},n,\nil>
        &\nst[1]\<p',n,e>\\
        &\nst[*]\delta'_\Hnst\,.
      \end{align*}
    \end{subcase}
    \begin{subcase}
      $\eval(\ceu{\Mem(\Id)})$~is false.
      %%
      Then, by~\R{if-false} and by the induction hypothesis, there is
      a~$\delta'$ such that
      \begin{align*}
        \<\ceu{\IfElse{\Mem(\Id)}{p'}{p''}},n,\nil>
        &\nst[1]\<p'',n,e>\\
        &\nst[*]\delta'_\Hnst\,.
      \end{align*}
    \end{subcase}
  \end{case}

  \begin{case}
    $p=\ceu{p';\,p''}$.
    %%
    There are three subcases.
    \begin{subcase}
      \label{thm.term-nst-*.seq-nop}
      $p'=\ceu{\Nop}$.
      %%
      Then, by~\R{seq-nop} and by the induction hypothesis, there is
      a~$\delta'$ such that
      \[
        \<\ceu{\Nop;\,p''},n,\nil>
        \nst[1]\<p'',n,e>\nst[*]\delta'_\Hnst\,.
      \]
    \end{subcase}
    \begin{subcase}
      \label{thm.term-nst-*.seq-brk}
      $p'=\ceu{\Break}$.
      %%
      Then, by~\R{seq-brk},
      \[
        \<\ceu{\Break;\,p''},n,\nil>\nst[1]\<\ceu{\Break},n,\nil>_\Hnst\,.
      \]
    \end{subcase}
    \begin{subcase}
      \label{thm.term-nst-*.seq-adv}
      $p'\ne\ceu{\Nop},\ceu{\Break}$.
      %%
      Then, by the induction hypothesis, there are~$p_1'$ and~$e$ such that
      \[
        \<p',n,\nil>\nst[*]\<p_1',n,e>_\Hnst\,.
      \]
      By item~\eqref{lem.props-nst-n.a} of Lemma~\ref{lem.props-nst-n},
      \begin{equation}
        \label{thm.term-nst-*.seq-adv.eq1}
        \<\ceu{p';\,p''},n,\nil>\nst[*]\<\ceu{p_1';\,p''},n,e>\,.
      \end{equation}
      It remains to be shown that~$\<\ceu{p_1';\,p''},n,e>$ is
      nested-irreducible.  There are four possibilities following from the
      fact that the simpler~$\<p_1',n,e>$ is nested-irreducible.
      %%
      \begin{subsubcase}
        $e\ne\nil$.  Then, by the definition of~$\Hnst$,
        description~$\<\ceu{p_1';\,p''},n,e>$ is nested-irreducible.
      \end{subsubcase}
      \begin{subsubcase}
        $p_1'=\ceu{\Nop}$.
        %%
        From~\eqref{thm.term-nst-*.seq-adv.eq1},
        \[
          \<\ceu{p';\,p''},n,\nil>\nst[*]\<\ceu{\Nop;\,p''},n,e>\,.
        \]
        From this point on, this case is similar to
        Case~\ref{thm.term-nst-*.seq-nop}.
      \end{subsubcase}
      \begin{subsubcase}
        $p_1'=\ceu{\Break}$.
        %%
        From~\eqref{thm.term-nst-*.seq-adv.eq1},
        \[
          \<\ceu{p';\,p''},n,\nil>\nst[*]\<\ceu{\Break;\,p''},n,e>\,.
        \]
        From this point on, this case is similar to
        Case~\ref{thm.term-nst-*.seq-brk}.
      \end{subsubcase}
      \begin{subsubcase}
        $\isblocked(p_1',n)$~is true.
        %%
        Then, by definition,
        \[
          \isblocked(\ceu{p_1';p''},n)=\isblocked(p_1',n)=\mathit{true}\,.
        \]
        Hence, from~\eqref{thm.term-nst-*.seq-adv.eq1} and by the
        definition~$\Hnst$, description~$\<\ceu{p_1';\,p''},n,e>$ is
        nested-irreducible.
      \end{subsubcase}
    \end{subcase}
  \end{case}

  \begin{case}
    \label{thm.term-nst-*.loop}
    $p=\ceu{\Loop{p'}}$.
    %%
    Then, by Assumption~\ref{ass.term-nst-loop},
    \begin{equation}\label{thm.term-nst-*.loop-expd.eq1}
      \<\ceu{\Loop{p'}},n,\nil>\nst[*]\<p_1',n,e>\,,
    \end{equation}
    for some~$e$ and~$p_1'$ such that either~$p_1'=\ceu{\Break\AtLoop{p'}}$
    or~$\isblockedext(p_1',n)$.
    \begin{subcase}
      $p_1'=\ceu{\Break\AtLoop{p'}}$.
      %%
      From~\eqref{thm.term-nst-*.loop-expd.eq1}, by~\R{loop-brk},
      \begin{align*}
        \<\ceu{\Loop{p'}},n,\nil>
        &\nst[*]\<\ceu{\Break\AtLoop{p'}},n,e>\\
        &\nst[1]\<\ceu{\Nop},n,e>_\Hnst\,.
      \end{align*}
    \end{subcase}
    \begin{subcase}
      $\isblockedext(p_1',n)$ is true.  Then, by definition,
      $\isblockedext(p_1',n)$ implies~$\isblocked(p_1',n)$.  Hence,
      from~\eqref{thm.term-nst-*.loop-expd.eq1} and by the definition
      of~$\Hnst$, $\<p_1',n,e>_\Hnst$.
    \end{subcase}
  \end{case}

  \begin{case}
    $p=\ceu{p'\AtLoop{p''}}$.  There are three subcases.
    \begin{subcase}
      $p'=\ceu{\Nop}$.
      %%
      Then, by~\R{loop-nop},
      \[
        \<\ceu{\Nop\AtLoop{p''}},n,\nil>
        \nst[1]\<\ceu{\Loop{p''}},n,\nil>\,.
      \]
      From this point on, this case is similar to
      Case~\ref{thm.term-nst-*.loop}.
    \end{subcase}
    \begin{subcase}
      $p'=\ceu{\Break}$.  Then, by~\R{loop-brk},
      \[
        \<\ceu{\Break\AtLoop{p''}},n,\nil>
        \nst[1]\<\ceu{\Nop},n,\nil>_\Hnst\,.
      \]
    \end{subcase}
    \begin{subcase}
      $p'\ne\ceu{\Nop},\ceu{\Break}$.  Then, by the induction hypothesis,
      there are~$p_1'$ and~$e$ such that
      \[
        \<p',n,\nil>\nst[*]\<p'_1,n,e>_\Hnst\,.
      \]
      By item~\eqref{lem.props-nst-n.b} of Lemma~\ref{lem.props-nst-n},
      \[
        \<\ceu{p'\AtLoop{p''}},n,\nil>
        \nst[*]\<\ceu{p_1'\AtLoop{p''}},n,e>\,.
      \]
      It remains to be show that~$\<\ceu{p_1'\AtLoop{p''}},n,e>$ is
      nested-irreducible.  The rest of this proof is similar to that of
      Case~\ref{thm.term-nst-*.seq-adv}.
    \end{subcase}
  \end{case}

  \begin{case}
    $p=\ceu{{p'}\And{p''}}$.
    %%
    Then, by~\R{and-expd},
    \[
      \<\ceu{{p'}\And{p''}},n,\nil>
      \nst[1]\<\ceu{{p'}\AtAnd{(\CanRun(n);\,p'')}},n,\nil>\,.
    \]
    From this point on, this case is similar to
    Case~\ref{thm.term-nst-*.and}.
  \end{case}

  \begin{case}\label{thm.term-nst-*.and}
    $p=\ceu{{p'}\AtAnd{p''}}$.
    %%
    There are two subcases.
    \begin{subcase}
      $\isblocked(p',n)$ is false.
      %%
      There are three subcases.
      \begin{subsubcase}
        \label{thm.term-nst-*.and.nop1}
        $p'=\ceu{\Nop}$.
        %%
        Then, by~\R{and-nop1} and by the induction hypothesis, there
        is a~$\delta'$ such that
        \[
          \<\ceu{{\Nop}\AtAnd{p''}},n,\nil>
          \nst[1]\<p'',n,\nil>
          \nst[*]\delta'_\Hnst\,.
        \]
      \end{subsubcase}
      \begin{subsubcase}
        \label{thm.term-nst-*.and.brk1}
        $p'=\ceu{\Break}$.
        %%
        Then, by~\R{and-brk1},
        \begin{equation}
          \label{thm.term-nst-*.and.brk1.eq1}
          \<\ceu{{\Break}\AtAnd{p''}},n,\nil>
          \nst[1]\<\ceu{\clear(p'');\,\Break},n,\nil>\,.
        \end{equation}
        From~\eqref{thm.term-nst-*.and.brk1.eq1}, by
        Assumption~\ref{ass.term-nst-fin} and~\R{seq-nop},
        \begin{align*}
          \<\ceu{\clear(p'');\,\Break},n,\nil>
          &\nst[*]\<\ceu{\Nop;\,\Break},n,\nil>\\
          &\nst[1]\<\ceu{\Break},n,\nil>_\Hnst\,.
        \end{align*}
      \end{subsubcase}
      \begin{subsubcase}
        \label{thm.term-nst-*.and.adv1}
        $p'\ne\ceu{\Nop},\ceu{\Break}$.
        %%
        Then, by the induction hypothesis, there are~$p_1'$ and~$e$ such
        that
        \[
          \<p',n,\nil>\nst[*]\<p_1',n,e>_\Hnst\,.
        \]
        By item~\eqref{lem.props-nst-n.c} of Lemma~\ref{lem.props-nst-n},
        \[
          \<\ceu{{p'}\AtAnd{p''}},n,\nil>
          \nst[*]\<\ceu{{p_1'}\AtAnd{p''}},n,e>\,.
        \]
        It remains to be show that~$\<\ceu{{p_1'}\AtAnd{p''}},n,e>$ leads to
        an nested-irreducible description.  There are four possibilities
        following from the fact that the simpler~$\<p_1',n,e>$ is
        nested-irreducible.
        \begin{enumerate}
        \item If~$e\ne\nil$ then, by
          definition,~$\<\ceu{{p_1'}\AtAnd{p''}},n,e>_\Hnst$.
        \item If~$p_1'=\ceu{\Nop}$, this case is similar to
          Case~\ref{thm.term-nst-*.and.nop1}.
        \item If~$p_1'=\ceu{\Break}$, this case is similar to
          Case~\ref{thm.term-nst-*.and.brk1}.
        \item If~$\isblocked(p_1',n)$, this case is similar to
          Case~\ref{thm.term-nst-*.and2}.
        \end{enumerate}
      \end{subsubcase}
    \end{subcase}
    \begin{subcase}
      \label{thm.term-nst-*.and2}
      $\isblocked(p',n)$ is true.
      %%
      There are three subcases.
      \begin{subsubcase}
        \label{thm.term-nst-*.and.nop2}
        $p''=\ceu{\Nop}$.
        %%
        Then, by~\R{and-nop2},
        \[
          \<\ceu{{p'}\AtAnd{\Nop}},n,\nil>\nst[1]\<p',n,\nil>_\Hnst\,.
        \]
      \end{subsubcase}
      \begin{subsubcase}
        \label{thm.term-nst-*.and.brk2}
        $p''=\ceu{\Break}$.
        %%
        Then, by~\R{and-brk2},
        \[
          \<\ceu{{p'}\AtAnd{\Break}},n,\nil>
          \nst[1]\<\ceu{\clear(p');\,\Break},n,\nil>\,.
        \]
        From this point on, this case is similar to
        Case~\ref{thm.term-nst-*.and.brk1}.
      \end{subsubcase}
      \begin{subsubcase}
        \label{thm.term-nst-*.and.adv2}
        $p''\ne\ceu{\Nop},\ceu{\Break}$.
        %%
        Then, by the induction hypothesis, there are~$p_1''$ and~$e$ such
        that
        \[
          \<p'',n,\nil>\nst[*]\<p_1'',n,e>_\Hnst\,.
        \]
        By item~\eqref{lem.props-nst-n.e} of Lemma~\ref{lem.props-nst-n},
        \[
          \<\ceu{{p'}\AtAnd{p''}},n,\nil>
          \nst[*]\<\ceu{{p'}\AtAnd{p_1''}},n,e>\,.
        \]
        It remains to be show that~$\<\ceu{{p'}\AtAnd{p_1''}},n,e>$ leads to
        an nested-irreducible description.  There are four possibilities
        following from the fact that the simpler~$\<p_1'',n,e>$ is
        nested-irreducible.
        \begin{enumerate}
        \item If~$e\ne\nil$ then, by definition,
          $\<\ceu{{p'}\AtAnd{p_1''}},n,e>_\Hnst$.
        \item If~$p_1''=\ceu{\Nop}$, this case is similar to
          Case~\ref{thm.term-nst-*.and.nop2}.
        \item If~$p_1''=\ceu{\Break}$, this case is similar to
          Case~\ref{thm.term-nst-*.and.brk2}.
        \item If~$\isblocked(p_1'',n)$ then, as both sides are blocked, by
          definition, $\<\ceu{{p'}\AtAnd{p_1''}},n,e>_\Hnst$.
        \end{enumerate}
      \end{subsubcase}
    \end{subcase}
  \end{case}

  \begin{case}
    $p=\ceu{{p'}\Or{p''}}$.
    %%
    Then, by~\R{or-expd},
    \[
      \<\ceu{{p'}\Or{p''}},n,\nil>
      \nst[1]\<\ceu{{p'}\AtOr{(\CanRun(n);\,p'')}},n,\nil>\,.
    \]
    From this point on, this case is similar to
    Case~\ref{thm.term-nst-*.or}.
  \end{case}

  \begin{case}
    \label{thm.term-nst-*.or}
    $p=\ceu{{p'}\AtOr{p''}}$.
    %%
    There are two subcases.
    \begin{subcase}
      $\isblocked(p',n)$~is false.
      %%
      There are three subcases.
      \begin{subsubcase}
        \label{thm.term-nst-*.or.nop1}
        $p'=\ceu{\Nop}$.  Then, by~\R{or-nop1},
        \begin{equation}
          \label{thm.term-nst-*.or.nop1.eq1}
          \<\ceu{{\Nop}\AtOr{p''}},n,\nil>
          \nst[1]\<\ceu{\clear(p'')},n,\nil>\,.
        \end{equation}
        From~\eqref{thm.term-nst-*.or.nop1.eq1}, by
        Assumption~\ref{ass.term-nst-fin},
        \[
          \<\ceu{\clear(p'')},n,\nil>\nst[*]\<\ceu{\Nop},n,\nil>_\Hnst\,.
        \]
      \end{subsubcase}
      \begin{subsubcase}
        \label{thm.term-nst-*.or.brk1}
        $p'=\ceu{\Break}$.
        %%
        Similar to Case~\ref{thm.term-nst-*.and.brk1}.
      \end{subsubcase}
      \begin{subsubcase}
        $p'\ne\ceu{\Nop},\ceu{\Break}$.
        %%
        Similar to Case~\ref{thm.term-nst-*.and.adv1}.
      \end{subsubcase}
    \end{subcase}
    \begin{subcase}
      \label{thm.term-nst-*.or.adv1}
      $\isblocked(p',n)$~is true.
      %%
      There are three subcases.
      \begin{subsubcase}
        $p''=\ceu{\Nop}$.
        %%
        Then, by~\R{or-nop2},
        \begin{equation}
          \label{thm.term-nst-*.or.nop2.eq1}
          \<\ceu{p'\AtOr{\Nop}},n,\nil>
          \nst[1]\<\clear(p'),n,\nil>\,.
        \end{equation}
        From~\eqref{thm.term-nst-*.or.nop2.eq1}, by
        Assumption~\ref{ass.term-nst-fin},
        \[
          \<\ceu{\clear(p')},n,\nil>\nst[*]\<\ceu{\Nop},n,\nil>_\Hnst\,.
        \]
      \end{subsubcase}
      \begin{subsubcase}
        $p''=\ceu{\Break}$.
        %%
        Similar to Case~\ref{thm.term-nst-*.and.brk2}.
      \end{subsubcase}
      \begin{subsubcase}
        $p''\ne\ceu{\Nop},\ceu{\Break}$.
        %%
        Similar to Case~\ref{thm.term-nst-*.and.adv2}.\qedhere
      \end{subsubcase}
    \end{subcase}
  \end{case}
\end{proof}


\begin{definition}
  \label{def.pot}
  %%
  The potency of a program~$p$ in reaction to event~$e$,
  denoted~$\pot(p,e)$, is the maximum number of~$\ceu{\EmitInt}$ expressions
  that can be executed during a reaction of~$p$ to~$e$.

  More formally,
  \[
    \pot(p,e)=\pot'(\bcast(p,e))\,,
  \]
  where~$\pot'$ is an auxiliary function that counts the number of
  reachable~$\ceu{\EmitInt}$ in the program resulting from the broadcast of
  event~$e$ to~$p$.

  The auxiliary function~$\pot'$ is defined by the following clauses:
  \begin{enumerate}[(a)]
    \item$\pot'(\ceu{\EmitInt}(e))=1$;
    \item$\pot'(\ceu{\IfElse{\Mem(\Id)}{p_1}{p_2}})
      =\max\{\pot'(p_1),\pot'(p_2)\}$;
    \item$\pot'(\ceu{\Loop{p_1}})=\pot'(p_1)$;
    \item If~$p_1\ne\ceu{\Break},\ceu{\AwaitExt(e)}$,
      \begin{align*}
        \pot'(\ceu{p_1;\,p_2})&=\pot'(p_1)+\pot'(p_2)\\
        %%
        \pot'(\ceu{p_1\AtLoop{p_2}})&=
        \begin{cases}
          \pot'(p_1)              &\text{if~(\dag)}\\
          \pot'(p_1)+\pot'(p_2)   &\text{otherwise}\\
        \end{cases}\\
        %%
        \pot'(\ceu{{p_1}\And{p_2}})&=\pot'(p_1)+\pot'(p_2)\\
        %%
        \pot'(\ceu{{p_1}\AtAnd{p_2}})&=\pot'(p_1)+\pot'(p_2)\\
        %%
        \pot'(\ceu{{p_1}\Or{p_2}})&=\pot'(p_1)+\pot'(p_2)\\
        %%
        \pot'(\ceu{{p_1}\AtOr{p_2}})&=\pot'(p_1)+\pot'(p_2)\,,
      \end{align*}
      where~(\dag) stands for: ``a~$\ceu{\Break}$ or~$\ceu{\AwaitExt}$
      occurs in all execution paths of~$p_1$'';
      \item Otherwise, if none of~(a)--(d) applies, $\pot(\ast)=0$.
    \end{enumerate}

  TODO: Define~$\pot'(\ceu{\Every{e}\,{p_1}})$ above.
\end{definition}


\begin{definition}\label{def.rank}
  The \emph{rank} of a description~$\delta=\<p,n,e>$,
  denoted~$\rank(\delta)$, is a pair of nonnegative integers~$\<i,j>$ such
  that
  \begin{alignat*}{2}
    i&=\pot(p,e) &\quad\text{and}\quad
    j&=
       \begin{cases}
         n  &\text{if~$e=\nil$}\\
         n+1&\text{otherwise\,.}
       \end{cases}
  \end{alignat*}
\end{definition}

The next two lemmas establish that a single application of an~$\out$
or~$\nst$ transition either preserves or decreases the rank of the input
description.  All rank comparisons assume lexicographical order.


\begin{lemma}\strut
  \begin{enumerate}[(a)]
  \item If~$\delta\outpush\delta'$ then~$\rank(\delta)=\rank(\delta')$.
  \item If~$\delta\outpop\delta'$ then~$\rank(\delta)>\rank(\delta')$.
  \end{enumerate}
\end{lemma}
\begin{proof}\strut
  Let~$\delta=\<p,n,e>$, $\delta'=\<p',n',e'>$,
  $\rank(\delta)=\<i,j>$, and~$\rank(\delta')=\<i',j'>$.
  \begin{enumerate}[(a)]
  \item Suppose~$\<p,n,e>\outpush\<p',n',e'>$.  Then, by~\R{push},
    $e\ne\nil$, $p'=\bcast(p,e)$, $n'=n+1$, and~$e'=\nil$.  By
    Definition~\ref{def.rank}, $j=n+1$, as~$e\ne\nil$, and~$j'=n+1$,
    as~$e'=\nil$ and~$n'=n+1$; hence~$j=j'$.
    %%
    It remains to be shown that~$i=i'$:
    \begin{align*}
      i&=\pot(p,e)
         \tag*{by Definition~\ref{def.rank}}\\
       &=\pot'(\bcast(p,e))
         \tag*{by Definition~\ref{def.pot}}\\
       &=\pot'(p')
         \tag*{since~$p'=\bcast(p,e)$}\\
       &=\pot'(\bcast(p',\nil))
         \tag*{by definition of~$\bcast$}\\
       &=\pot'(\bcast(p',e'))
         \tag*{since~$e'=\nil$}\\
       &=\pot(p',e')
         \tag*{by Definition~\ref{def.pot}}\\
       &=i'
         \tag*{by Definition~\ref{def.rank}}
    \end{align*}
    Therefore, $\<i,j>=\<i',j'>$.

  \item Suppose~$\<p,n,e>\outpop\<p',n',e'>$.  Then, by~\R{pop}, $p=p'$,
    $n>0$, $n'=n-1$, and~$e=e'=\nil$.
    %%
    By Definition~\ref{def.pot}, $\pot(\bcast(p,e))=\pot(\bcast(p',e'))$;
    hence~$i=i'$.  And by Definition~\ref{def.rank}, $j=n$, as~$e=\nil$,
    and~$j'=n-1$, as~$e'=\nil$ and~$n'=n-1$; hence~$j>j'$.
    Therefore,~${\<i,j>}>{\<i',j'>}$.\qedhere
  \end{enumerate}
\end{proof}


\begin{lemma}
  \label{lem.rank-nst}
  %%
  If~$\delta\nst\delta'$ then~$\rank(\delta)\ge\rank(\delta')$.
\end{lemma}
\begin{proof}
  We proceed by induction on the structure of~$\nst$ derivations.
  Let~$\delta=\<p,n,e>$, $\delta'=\<p',n',e'>$, $\rank(\delta)=\<i,j>$,
  and~$\rank(\delta')=\<i',j'>$.  By the theorem hypothesis, there is a
  derivation~$\pi$ such that
  \[
    \pi\Vdash\<p,n,e>\nst\<p',n',e'>\,.
  \]
  By definition of~$\nst$, $e=\nil$ and $n=n'$.  Depending on the structure
  of program~$p$, there are~11 possibilities.  In each one of them, we show
  that~$\rank(\delta)\ge\rank(\delta')$.

  \begin{case}
    $p=\ceu{\Mem(id)}$.
    %%
    Then~$\pi$ is an instance of~\R{mem}.  Hence~$p'=\ceu{\Nop}$
    and~$e'=\nil$.  Thus
    \[
      \rank(\delta)=\rank(\delta')=\<0,n>\,.
    \]
  \end{case}

  \begin{case}
    $p=\ceu{\EmitInt(e_1)}$.
    %%
    Then~$\pi$ is an instance of~\R{emit-int}.  Hence~$p'=\ceu{\Nop}$
    and~$e'=e_1\ne\nil$.
    Thus
    \[
      {\rank(\delta)={\<1,n>}}>{\<0,n+1>=\rank(\delta')}\,.
    \]
  \end{case}

  \begin{case}
    $p=\ceu{\CanRun(n)}$.
    %%
    Then~$\pi$ is an instance of~\R{can-run}.  Hence~$p'=\ceu{\Nop}$
    and~$e'=\nil$.  Thus
    \[
      \rank(\delta)=\rank(\delta')=\<0,n>\,.
    \]
  \end{case}

  \begin{case}
    $p=\ceu{\IfElse{p}{p_1}{p_2}}$.
    %%
    There are two subcases.
    \begin{subcase}
      \label{lem.rank-nst.if-true}
      $\eval(\ceu{\Mem(\Id)})$~is true.
      %%
      Then~$\pi$ is an instance of~\R{if-true}.  Hence~$p'=\ceu{p_1}$
      and~$e'=\nil$.  Thus
      \begin{align*}
        \rank(\delta)&=\<\max\{pot'(p_1),pot'(p_2)\},n>\\
                     &\ge\<\pot'(p_1),n>=\rank(\delta')\,.
      \end{align*}
    \end{subcase}
    \begin{subcase}
      $\eval(\ceu{\Mem(\Id)})$~is false.
      %%
      Similar to Case~\ref{lem.rank-nst.if-true}.
    \end{subcase}
  \end{case}

  \begin{case}
    $p=\ceu{p_1;\,p_2}$.
    %%
    There are three subcases.
    \begin{subcase}
      \label{lem.rank-nst.seq-nop}
      $p_1=\ceu{\Nop}$.
      %%
      Then~$\pi$ is an instance of~\R{seq-nop}.
      Hence~$p'=p_2$ and~$e'=\nil$.  Thus
      \begin{align*}
        \rank(\delta)&=\<\pot'(p_1)+\pot'(p_2),n>\\
                     &\ge\<pot'(p_2),n>=\rank(\delta')\,.
      \end{align*}
    \end{subcase}
    \begin{subcase}
      \label{lem.rank-nst.seq-brk}
      $p_1=\ceu{\Break}$.
      %%
      Then~$\pi$ is an instance of~\R{seq-brk}.
      Hence~$p'=p_1$ and~$e'=\nil$.  Thus
      \[
        \rank(\delta)=\<0,n>=\rank(\delta')\,.
      \]
    \end{subcase}
    \begin{subcase}
      \label{lem.rank-nst.seq-adv}
      $p_1\ne\ceu{\Nop},\ceu{\Break}$.
      %%
      Then~$\pi$ is an instance of~\R{seq-adv}.  Hence there is a
      derivation~$\pi'$ such that
      \[
        \pi'\Vdash\<p_1,n,\nil>\nst\<p_1',n,e_1'>\,,
      \]
      for some~$p_1'$ and~$e_1'$.  Thus~$p'=p_1';p_2$ and~$e'=e_1'$.  By the
      induction hypothesis,
      \begin{equation}
        \label{lem.rank-nst.seq-adv.eq1}
        \rank(\<p_1,n,\nil>)\ge\rank(\<p_1',n,e_1'>)\,.
      \end{equation}
      There are two subcases.
      \begin{subsubcase}
        $e'=\nil$.
        %%
        Then
        \begin{align*}
          \rank(\delta)&=\<\pot'(p_1)+\pot'(p_2),n>\enspace\text{and}\\
          \rank(\delta')&=\<\pot'(p_1')+\pot'(p_2),n>\,.
        \end{align*}
        By~\eqref{lem.rank-nst.seq-adv.eq1}, $\pot'(p_1)\ge\pot'(p_1')$.
        Thus
        \[
          \rank(\delta)\ge\rank(\delta')\,.
        \]
      \end{subsubcase}
      \begin{subsubcase}
        $e'\ne\nil$.
        %%
        Then~$\pi'$ contain one application of~\R{emit-int}, which consumes
        one~$\ceu{\EmitInt(e')}$ expression from~$p_1$ and implies
        $\pot'(p_1)>\pot'(p_1')$.  Thus
        \begin{align*}
          \rank(\delta)&=\<\pot'(p_1)+\pot'(p_2),n>\\
                       &>\<\pot'(p_1')+\pot'(p_2),n+1>=\rank(\delta')\,.
        \end{align*}
      \end{subsubcase}
    \end{subcase}
  \end{case}

  \begin{case}
    \label{lem.rank-nst.loop-expd}
    $p=\ceu{\Loop{p_1}}$.
    %%
    Then~$\pi$ is an instance of~\R{loop-expd}.
    Hence~$p'=\ceu{p_1\AtLoop{p_1}}$ and~$e'=\nil$.
    %%
    TODO: Use condition~(\dag) in definition of~$\pot'$.
  \end{case}

  \begin{case}
    $p=\ceu{{p_1}\AtLoop{p_2}}$.
    %%
    There are three cases.
    \begin{subcase}
      $p_1=\ceu{\Nop}$.
      %%
      Similar to Case~\ref{lem.rank-nst.seq-nop}.
    \end{subcase}
    \begin{subcase}
      $p_1=\ceu{\Break}$.
      %%
      Similar to Case~\ref{lem.rank-nst.seq-brk}.
    \end{subcase}
    \begin{subcase}
      \label{lem.rank-nst.loop-adv}
      $p_1\ne\ceu{\Nop},\ceu{\Break}$.
      %%
      Similar to Case~\ref{lem.rank-nst.seq-adv}.
    \end{subcase}
  \end{case}

  \begin{case}
    \label{lem.rank-nst.and.expd}
    $p=\ceu{{p_1}\And{p_2}}$.
    %%
    Then~$\pi$ is an instance of~\R{and-expd}.
    Hence~$p'=\ceu{{p_1}\AtAnd(\CanRun(n);\,p_2)}$ and~$e'=\nil$.
  \end{case}

  \begin{case}
    $p=\ceu{{p_1}\AtAnd{p_2}}$.
  \end{case}

  \begin{case}
    $p=\ceu{{p_1}\Or{p_2}}$.
  \end{case}

  \begin{case}
    $p=\ceu{{p_1}\AtOr{p_2}}$.
  \end{case}
\end{proof}

\begin{theorem}[Reaction termination]
  For any~$\delta$ there is a~$\delta'_\Hnst$ such
  that~$\delta\trans[*]\delta'$ and~$\rank(\delta')=\<0,0>$.
\end{theorem}
\begin{proof}
  By lexicographic induction on~$rank(\delta)$.
\end{proof}
%   \begin{basis}
%     If~$\<i,j>=\<0,0>$ then, by~\ref{?}, $\delta$ cannot be advanced
%     by~$\out$ transitions.  There are two possibilities\dots\ (it can or
%     cannot be advanced by nst transitions).
%   \end{basis}
%   \begin{induction}
%     Let~$\<i,j>\ne\<0,0>$ and suppose that the theorem holds for
%     all~$\delta''$ such that~$\rank(\delta'')<\rank(\delta)$.
%     \begin{case}
%       $\delta$~is nested-irreducible.
%       %%
%       \begin{subcase}
%         $\delta\outpush\delta_1$, for some~$\delta_1$.
%       \end{subcase}
%       \begin{subcase}
%         $\delta\outpop\delta_1$, for some~$\delta_1$.
%         %%
%         Then, by definition of~\R{pop}, $\rank(\delta_1)=\<i,j-1>$, and by
%         the induction hypothesis\dots
%       \end{subcase}
%     \end{case}
%     \begin{case}
%       $\delta$~is not nested-irreducible.
%       %%
%     \end{case}
%   \end{induction}
