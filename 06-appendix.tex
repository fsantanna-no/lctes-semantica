\section{Detailed Proofs}
\label{sec.proofs}


\lemxdetout*
\begin{proof}
  The lemma is vacuously true if~$\delta$ cannot be advanced by~$\out$
  transitions.  Suppose that is not the case and let~$\delta=\<p,n,e>$,
  $\delta_1=\<p_1,n_1,e_1>$ and~$\delta_2=\<p_2,n_2,e_2>$.  Then, there are
  two possibilities.
  \begin{casex}
  \item $e\ne\nil$.  Both transitions are applications of~\R{push}.
    Hence~$p_1=p_2=\bcast(p,e)$, $n_1=n_2=n+1$, and~$e_1=e_2=\nil$.
    %%
  \item $e=\nil$.  Both transitions are applications of~\R{pop}.
    Hence $p_1=p_2=p$, $n_1=n_2=n-1$, and~$e_1=e_2=\nil$.\qedhere
  \end{casex}
\end{proof}


\lemxdetnst*
\begin{proof}
  By induction on the structure of~$\nst$ derivations.  The lemma is
  vacuously true if~$\delta$ cannot be advanced by~$\nst$ transitions.
  Suppose that is not the case and let~$\delta=\<p,n,e>$,
  $\delta_1=\<p_1,n_1,e_1>$ and~$\delta_2=\<p_2,n_2,e_2>$.  Then, by the
  hypothesis of the lemma, there are derivations~$\pi_1$ and~$\pi_2$ such
  that
  \begin{align*}
    \pi_1&\Vdash\<p,n,e>\nst\<p_1,n_1,e_1>\\
    \pi_2&\Vdash\<p,n,e>\nst\<p_2,n_2,e_2>
  \end{align*}
  i.e., the conclusion of~$\pi_1$ is~$\<p,n,e>\nst\<p_1,n_1,e_1>$ and the
  conclusion of~$\pi_2$ is~$\<p,n,e>\nst\<p_2,n_2,e_2>$.

  By definition of~$\nst$, we have that~$e=\nil$ and $n_1=n_2=n$.  It
  remains to be shown that~$p_1=p_2$ and~$e_1=e_2$.

  Depending on the structure of program~$p$, the following~11 cases are
  possible.  (Note that~$p$ cannot be an~$\ceu{\AwaitExt}$,
  $\ceu{\AwaitInt}$, $\ceu{\Break}$, $\ceu{\Every}$, $\ceu{\Fin}$,
  or~$\ceu{\Nop}$ statement as there are no~$\nst$ rules to transition such
  programs.)

  \begin{casex}
  \item $p=\ceu{\Mem(\Id)}$.
    %%
    Then derivations~$\pi_1$ and~$\pi_2$ are instances of rule~\R{mem},
    i.e., their conclusions are obtained by an application of this rule.
    Hence~$p_1=p_2=\ceu{\Nop}$ and~$e_1=e_2=\nil$.
    %%
  \item $p=\ceu{\EmitInt(e')}$.
    %%
    Then~$\pi_1$ and~$\pi_2$ are instances of~\R{emit-int}.
    Hence~$p_1=p_2=\ceu{\CanRun(n)}$ and~$e_1=e_2=e'$.
    %%
  \item $p=\ceu{\CanRun(n)}$.
    %% \
    Then~$\pi_1$ and~$\pi_2$ are instances of~\R{can-run}.
    Hence~$p_1=p_2=\ceu{\Nop}$ and~$e_1=e_2=\nil$.
    %%
  \item $p=\ceu{\IfElse{\Mem(\Id)}{p'}{p''}}$.
    %%
    There are two subcases.
    \begin{casex}
    \item$\eval(\ceu{\Mem(\Id)})$.
      %%
      Then~$\pi_1$ and~$\pi_2$ are instances of~\R{if-true}.
      Hence~$p_1=p_2=p'$ and~$e_1=e_2=\nil$.
      %%
    \item$\lnot\eval(\ceu{\Mem(\Id)})$.
      %%
      Then~$\pi_1$ and~$\pi_2$ are instances of~\R{if-false}.
      Hence~$p_1=p_2=p''$ and~$e_1=e_2=\nil$.
    \end{casex}
    %%
  \item$p=\ceu{p';\,p''}$.
    %%
    There are three subcases.
    \begin{casex}
    \item $p'=\ceu{\Nop}$.
      %%
      Then~$\pi_1$ and~$\pi_2$ are instances of~\R{seq-nop}.
      Hence~$p_1=p_2=p''$ and~$e_1=e_2=\nil$.
      %%
    \item $p'=\ceu{\Break}$.
      %%
      Then~$\pi_1$ and~$\pi_2$ are instances of~\R{seq-brk}.
      Hence~$p_1=p_2=\ceu{\Break}$ and~$e_1=e_2=\nil$.
      %%
    \item $p'\ne\ceu{\Nop},\ceu{\Break}$.
      %%
      Then~$\pi_1$ and~$\pi_2$ are instances of~\R{seq-adv}.  Thus there
      are derivations~$\pi_1'$ and~$\pi_2'$ such that
      \begin{align*}
        \pi_1'&\Vdash\<p',n,\nil>\nst\<p_1',n,e_1'>\\
        \pi_2'&\Vdash\<p',n,\nil>\nst\<p_2',n,e_2'>
      \end{align*}
      for some~$p_1'$, $p_2'$, $e_1'$, and~$e_2'$.  By the induction
      hypothesis, $p_1'=p_2'$ and~$e_1'=e_2'$.
      Hence~$p_1=\ceu{p_1';p''}=\ceu{p_2';p''}=p_2$
      and~$e_1=e_1'=e_2'=e_2$.
    \end{casex}
    %%
  \item $p=\ceu{\Loop{p'}}$.
    %%
    Then~$\pi_1$ and~$\pi_2$ are instances of~\R{loop-expd}.
    Hence~$p_1=p_2=\ceu{p'\AtLoop{p'}}$ and~$e_1=e_2=\nil$.
    %%
  \item $p=\ceu{p'\AtLoop{p''}}$.
    %%
    There are three subcases.
    \begin{casex}
    \item $p'=\ceu{\Nop}$.
      %%
      Then~$\pi_1$ and~$\pi_2$ are instances of~\R{loop-nop}.
      Hence~$p_1=p_2=\ceu{\Loop{p''}}$ and~$e_1=e_2=\nil$.
      %%
    \item $p'=\ceu{\Break}$.
      %%
      Then~$\pi_1$ and~$\pi_2$ are instances of~\R{loop-brk}.
      Hence~$p_1=p_2=\ceu{\Nop}$ and~$e_1=e_2=\nil$.
      %%
    \item $p'\ne\ceu{\Nop},\ceu{\Break}$.
      %%
      Then~$\pi_1$ and~$\pi_2$ are instances of~\R{loop-adv}.  Thus there
      are derivations~$\pi_1'$ and~$\pi_2'$ such that
      \begin{align*}
        \pi_1'&\Vdash\<p',n,\nil>\nst\<p_1',n,e_1'>\\
        \pi_2'&\Vdash\<p',n,\nil>\nst\<p_2',n,e_2'>
      \end{align*}
      for some~$p_1'$, $p_2'$, $e_1'$, and~$e_2'$.  By the induction
      hypothesis, $p_1'=p_2'$ and~$e_1'=e_2'$.
      Hence~$p_1=\ceu{p_1'\AtLoop{p''}}=\ceu{p_2'\AtLoop{p''}}=p_2$
      and~$e_1=e_1'=e_2'=e_2$.
    \end{casex}
  \item $p=\ceu{p'\And{p''}}$.
    %%
    Then~$\pi_1$ and~$\pi_2$ are instances of~\R{and-expd}.
    Hence~$p_1=p_2=\ceu{{p'}\AtAnd{(\CanRun(n);\,p'')}}$
    and~$e_1=e_2=\nil$.
    %%
  \item $p=\ceu{p'\AtAnd{p''}}$.
    %%
    There are two subcases.
    \begin{casex}
    \item$\lnot\isblocked(p',n)$.
      %%
      There are three subcases.
      \begin{casex}
      \item $p'=\ceu{\Nop}$.
        %%
        Then~$\pi_1$ and~$\pi_2$ are instances of~\R{and-nop1}.
        Hence~$p_1=p_2=p''$ and~$e_1=e_2=\nil$.
        %%
      \item\label{lem.x.det-nst.and-brk1}
        $p'=\ceu{\Break}$.
        %%
        Then~$\pi_1$ and~$\pi_2$ are instances of~\R{and-brk1}.
        Hence~$p_1=p_2=\ceu{\clear(p'');\Break}$ and~$e_1=e_2=\nil$.
        %%
      \item\label{lem.x.det-nst.and-adv1}$p'\ne\ceu{\Nop},\ceu{\Break}$.
        %%
        Then~$\pi_1$ and~$\pi_2$ are instances of~\R{and-adv1}.  Thus
        there are derivations~$\pi_1'$ and~$\pi_2'$ such that
        \begin{align*}
          \pi_1'&\Vdash\<p',n,\nil>\nst\<p_1',n,e_1'>\\
          \pi_2'&\Vdash\<p',n,\nil>\nst\<p_2',n,e_2'>
        \end{align*}
        for some~$p_1'$, $p_2'$, $e_1'$, $e_2'$.  By the induction
        hypothesis, $p_1'=p_2'$ and~$e_1'=e_2'$.
        Hence~$p_1=\ceu{{p_1'}\And{p''}}=\ceu{{p_2'}\And{p''}}=p_2$
        and~$e_1=e_1'=e_2'=e_2$.
      \end{casex}
      %%
    \item$\isblocked(p',n)$.
      %%
      There are three subcases.
      \begin{casex}
      \item $p''=\ceu{\Nop}$.
        %%
        Then~$\pi_1$ and~$\pi_2$ are instances of~\R{and-nop2}.
        Hence~$p_1=p_2=p'$ and~$e_1=e_2=\nil$.
        %%
      \item\label{lem.x.det-nst.and-brk2}$p''=\ceu{\Break}$.
        %%
        Then~$\pi_1$ and~$\pi_2$ are instances of~\R{and-brk2}.
        Hence~$p_1=p_2=\ceu{\clear(p');\Break}$ and~$e_1=e_2=\nil$.
        %%
      \item\label{lem.x.det-nst.and-adv2}$p''\ne\ceu{\Nop},\ceu{\Break}$.
        %%
        Then~$\pi_1$ and~$\pi_2$ are instances of~\R{and-adv2}.  Thus
        there are derivations~$\pi_1''$ and~$\pi_2''$ such that
        \begin{align*}
          \pi_1''&\Vdash\<p'',n,\nil>\nst\<p_1'',n,e_1''>\\
          \pi_2''&\Vdash\<p'',n,\nil>\nst\<p_2'',n,e_2''>
        \end{align*}
        for some~$p_1''$, $p_2''$, $e_1''$, and~$e_2''$.  By the induction
        hypothesis, $p_1''=p_2''$ and~$e_1''=e_2''$.
        Hence~$p_1=\ceu{{p'}\And{p_1''}}=\ceu{{p'}\And{p_2''}}=p_2$
        and~$e_1=e_1''=e_2''=e_2$.
      \end{casex}
    \end{casex}
    %%
  \item$p=\ceu{p'\Or{p''}}$.
    %%
    Then~$\pi_1$ and~$\pi_2$ are instances of~\R{or-expd}.
    Hence~$p_1=p_2=\ceu{{p'}\AtOr{(\CanRun(n);\,p'')}}$
    and~$e_1=e_2=\nil$.
    %%
  \item$p=\ceu{p'\AtOr{p''}}$.
    %%
    There are two subcases.
    \begin{casex}
    \item$\lnot\isblocked(p',n)$.
      %%
      There are three subcases.
      \begin{casex}
      \item $p'=\ceu{\Nop}$.
        %%
        Then~$\pi_1$ and~$\pi_2$ are instances of~\R{or-nop1}.
        Hence~$p_1=p_2=\clear(p'')$ and~$e_1=e_2=\nil$.
        %%
      \item $p'=\ceu{\Break}$.
        %%
        Similar to Case~\ref{lem.x.det-nst.and-brk1}.
        %%
      \item$p'\ne\ceu{\Nop},\ceu{\Break}$.
        %%
        Similar to Case~\ref{lem.x.det-nst.and-adv1}.
      \end{casex}
      %%
    \item$\isblocked(p',n)$.
      %%
      There are three subcases.
      \begin{casex}
      \item $p''=\ceu{\Nop}$.
        %%
        Then~$\pi_1$ and~$\pi_2$ are instances of~\R{or-nop1}.
        Hence~$p_1=p_2=\clear(p')$ and~$e_1=e_2=\nil$.
        %%
      \item $p''=\ceu{\Break}$.
        %%
        Similar to Case~\ref{lem.x.det-nst.and-brk2}.
        %%
      \item $p''\ne\ceu{\Nop},\ceu{\Break}$.
        %%
        Similar to Case~\ref{lem.x.det-nst.and-adv2}.
        %%
      \end{casex}
    \end{casex}
  \end{casex}
\end{proof}


\thmxdet*
\begin{proof}
  By induction on~$i$.  The theorem is trivially true if~$i=0$ and follows
  directly from Lemmas~\ref{lem.x.det-out} and~\ref{lem.x.det-nst} for~$i=1$.
  %%
  Suppose
  \[
    \delta\trans[1]\delta_1'\trans[i-1]\delta_1
    \quad\text{and}\quad
    \delta\trans[1]\delta_2'\trans[i-1]\delta_2\,,
  \]
  for some~$i>1$, $\delta_1'$ and~$\delta_2'$.
  There are two possibilities.
  \begin{casex}
  \item $\delta\out[1]\delta_1'$ and~$\delta\out[1]\delta_2'$.  Then, by
    Lemma~\ref{lem.x.det-out}, $\delta_1'=\delta_2'$, and by the induction
    hypothesis, $\delta_1=\delta_2$.
    %%
  \item $\delta\nst[1]\delta_1'$ and~$\delta\nst[1]\delta_2'$.  Then, by
    Lemma~\ref{lem.x.det-nst}, $\delta_1'=\delta_2'$, and by the induction
    hypothesis, $\delta_1=\delta_2$.\qedhere
  \end{casex}
\end{proof}


\propxirrnsti*
\begin{proof}
  By contradiction on the hypothesis that there is such~$k$.
  %%
  Let~$\delta\nst[i]\delta'_\Hnst$, for some~$i\ge0$.
  %%
  There are two cases.
  \begin{casex}
  \item\label{prop.x.irr-nst-i-case1}
    %%
    Suppose there are~$k>i$ and~$\delta''_\Hnst$ such
    that~$\delta\nst[k]\delta''$.
    %%
    Then, by definition of~$\nst[k]$,
    \begin{equation}
      \label{prop.x.irr-nst-i-eq1}
      %%
      \delta\nst[i]\delta'\nst[i+1]\delta_1'\nst[i+2]\cdots\nst[k]\delta''.
    \end{equation}
    Since~$\delta'=\<p',n,e'>$ is nested-irreducible, $e'=\nil$
    or~$p=\ceu{\Nop},\ceu{\Break}$ or~$\isblocked(p',n)$.  In any of these
    cases, by the definition of~$\nst$, there is no~$\delta_1'$ such
    that~$\delta'\nst[1]\delta_1'$, which
    contradicts~\eqref{prop.x.irr-nst-i-eq1}.  Therefore, no such~$k$ can
    exist.
    %%
  \item Suppose there are~$k<i$ and~$\delta''_\Hnst$ such
    that~$\delta\nst[k]\delta''$.  Then, since~$i>k$, by
    Case~\ref{prop.x.irr-nst-i-case1}, $\delta'$~cannot exist, which is
    absurd.  Therefore, the assumption that there is such~$k$ is
    false.\qedhere
  \end{casex}
\end{proof}


\lemxpropsnsti*
\begin{proof}
  By induction on~$i$.
  %%
  \begin{enumerate:a}
  \item The lemma is trivially true for~$i=0$, as~$p_1=p_1'$, and follows
    directly from~\R{seq-adv} for~$i=1$.  Suppose
    \begin{equation}
      \label{lem.x.props-nst-i.a.eq1}
      \<p_1,n,e>\nst[1]\<p_1'',n,e''>\nst[i-1]\<p_1',n,e'>\,,
    \end{equation}
    for some~$i>1$.  Then~$\<p_1'',n,e''>$ is not nested-irreducible, i.e.,
    $e=\nil$ and~$p\ne{\ceu{\Nop},\ceu{\Break}}$
    and~$\lnot\isblocked(p_1'',n)$.  By~\eqref{lem.x.props-nst-i.a.eq1} and
    by~\R{seq-adv},
    \begin{equation}
      \label{lem.x.props-nst-i.a.eq2}
      \<\ceu{p_1;\,p_2},n,e>\nst[1]\<\ceu{p_1'';\,p_2},n,e''>\,.
    \end{equation}
    From~\eqref{lem.x.props-nst-i.a.eq1}, by the induction hypothesis,
    \begin{equation}
      \label{lem.x.props-nst-i.a.eq3}
      \<\ceu{p_1'';\,p_2},n,e''>\nst[i-1]\<\ceu{p_1';\,p_2},n,e'>\,.
    \end{equation}
    From~\eqref{lem.x.props-nst-i.a.eq2}
    and~\eqref{lem.x.props-nst-i.a.eq3},
    \[
      \<\ceu{p_1;\,p_2},n,e>\nst[i]\<\ceu{p_1';\,p_2},n,e'>\,.
    \]

  \item Similar to item~\ref{lem.x.props-nst-i.a}.
    %%
    % The lemma is trivially true for~$n=0$, as~$p_1=p_1'$, and follows
    % directly from~\R{loop-adv} for~$n=1$.  Suppose
    % \begin{equation}
    %   \label{lem.x.props-nst-i.b.eq1}
    %   \<p_1,n,e>\nst[1]\<p_1'',n,e''>\nst[n-1]\<p_1',n,e'>\,,
    % \end{equation}
    % for some~$n>1$.  Then~$\<p_1'',n,e''>$ is not nested-irreducible.
    % By~\eqref{lem.x.props-nst-i.b.eq1} and by~\R{loop-adv},
    % \begin{equation}
    %   \label{lem.x.props-nst-i.b.eq2}
    %   \<\ceu{p_1\AtLoop{p_2}},n,e>\nst[1]\<\ceu{p_1''\Loop{p_2}},n,e''>\,.
    % \end{equation}
    % From~\eqref{lem.x.props-nst-i.b.eq1}, by the induction hypothesis,
    % \begin{equation}
    %   \label{lem.x.props-nst-i.b.eq3}
    %   \<\ceu{p_1''\AtLoop{p_2}},n,e''>
    %   \nst[n-1]\<\ceu{p_1'\AtLoop{p_2}},n,e'>\,.
    % \end{equation}
    % From~\eqref{lem.x.props-nst-i.b.eq2} and~\eqref{lem.x.props-nst-i.b.eq3},
    % \[
    %   \<\ceu{p_1\AtLoop{p_2}},n,e>\nst[n]\<\ceu{p_1'\AtLoop{p_2}},n,e'>\,.
    % \]
    %%

  \item Similar to item~\ref{lem.x.props-nst-i.a}.
    %%
    % The lemma is trivially true for~$n=0$, as~$p_1=p_1'$, and follows
    % directly from~\R{and-adv1} for~$n=1$.  Suppose
    % \begin{equation}
    %   \label{lem.x.props-nst-i.c.eq1}
    %   \<p_1,n,e>\nst[1]\<p_1'',n,e''>\nst[n-1]\<p_1',n,e'>\,,
    % \end{equation}
    % for some~$n>1$.  Then~$\<p_1'',n,e''>$ is not nested-irreducible.
    % By~\eqref{lem.x.props-nst-i.c.eq1} and by~\R{and-adv1},
    % \begin{equation}
    %   \label{lem.x.props-nst-i.c.eq2}
    %   \<\ceu{{p_1}\AtAnd{p_2}},n,e>
    %   \nst[1]\<\ceu{{p_1}''\AtAnd{p_2}},n,e''>\,.
    % \end{equation}
    % From~\eqref{lem.x.props-nst-i.c.eq1}, by the induction hypothesis,
    % \begin{equation}
    %   \label{lem.x.props-nst-i.a.eq3}
    %   \<\ceu{{p_1''}\AtAnd{p_2}},n,e''>
    %   \nst[n-1]\<\ceu{{p_1'}\AtAnd{p_2}},n,e'>\,.
    % \end{equation}
    % From~\eqref{lem.x.props-nst-i.c.eq2} and~\eqref{lem.x.props-nst-i.c.eq3},
    % \[
    %   \<\ceu{{p_1}\AtAnd{p_2}},n,e>
    %   \nst[n]\<\ceu{{p_1'}\AtAnd{p_2}},n,e'>\,.
    % \]
    %%

  \item Similar to item~\ref{lem.x.props-nst-i.a}.
    %%
    % The lemma is trivially true for~$n=0$, as~$p_1=p_1'$, and follows
    % directly from~\R{or-adv1} for~$n=1$.  Suppose
    % \begin{equation}
    %   \label{lem.x.props-nst-i.d.eq1}
    %   \<p_1,n,e>\nst[1]\<p_1'',n,e''>\nst[n-1]\<p_1',n,e'>\,,
    % \end{equation}
    % for some~$n>1$.  Then~$\<p_1'',n,e''>$ is not nested-irreducible.
    % By~\eqref{lem.x.props-nst-i.d.eq1} and by~\R{or-adv1},
    % \begin{equation}
    %   \label{lem.x.props-nst-i.d.eq2}
    %   \<\ceu{{p_1}\AtOr{p_2}},n,e>
    %   \nst[1]\<\ceu{{p_1}''\AtOr{p_2}},n,e''>\,.
    % \end{equation}
    % From~\eqref{lem.x.props-nst-i.d.eq1}, by the induction hypothesis,
    % \begin{equation}
    %   \label{lem.x.props-nst-i.a.eq3}
    %   \<\ceu{{p_1''}\AtOr{p_2}},n,e''>
    %   \nst[n-1]\<\ceu{{p_1'}\AtOr{p_2}},n,e'>\,.
    % \end{equation}
    % From~\eqref{lem.x.props-nst-i.d.eq2} and~\eqref{lem.x.props-nst-i.d.eq3},
    % \[
    %   \<\ceu{{p_1}\AtOr{p_2}},n,e>
    %   \nst[n]\<\ceu{{p_1'}\AtOr{p_2}},n,e'>\,.
    % \]
    %%

  \item The lemma is trivially true for~$i=0$, as~$p_2=p_2'$, and follows
    directly from~\R{and-adv2} for~$i=1$.  Suppose
    \begin{equation}
      \label{lem.x.props-nst-i.e.eq1}
      \<p_2,n,e>\nst[1]\<p_2'',n,e''>\nst[i-1]\<p_2',n,e'>\,,
    \end{equation}
    for some~$i>1$.  Then~$\<p_2'',n,e''>$ is not nested-irreducible.
    By~\eqref{lem.x.props-nst-i.e.eq1} and by~\R{and-adv2},
    \begin{equation}
      \label{lem.x.props-nst-i.e.eq2}
      \<\ceu{{p_1}\AtAnd{p_2}},n,e>
      \nst[1]\<\ceu{{p_1}\AtAnd{p_2''}},n,e''>\,.
    \end{equation}
    From~\eqref{lem.x.props-nst-i.e.eq1}, by the induction hypothesis,
    \begin{equation}
      \label{lem.x.props-nst-i.e.eq3}
      \<\ceu{{p_1}\AtAnd{p_2''}},n,e''>
      \nst[i-1]\<\ceu{{p_1}\AtOr{p_2'}},n,e'>\,.
    \end{equation}
    From~\eqref{lem.x.props-nst-i.e.eq2}
    and~\eqref{lem.x.props-nst-i.e.eq3},
    \[
      \<\ceu{{p_1}\AtAnd{p_2}},n,e>
      \nst[i]\<\ceu{{p_1}\AtAnd{p_2'}},n,e'>\,.
    \]

  \item Similar to item~\ref{lem.x.props-nst-i.e}.\qedhere
  \end{enumerate:a}
\end{proof}


\thmxtermnstx*
\begin{proof}
  By induction on the structure of programs.
  %%
  Let~$\delta=\<p,n,\nil>$.  The theorem is trivially true if~$\delta$ is
  nested-irreducible, as by definition~$\delta\nst[0]\delta$.  Suppose that
  is not the case.  Then, depending on the structure of~$p$, there are~11
  possibilities.  In each one of them, we show that such~$\delta'_\Hnst$
  indeed exists.
  \begin{casex}
  \item $p=\ceu{\Mem(\Id)}$.
    %%
    Then, by~\R{mem},
    \[
      \<\ceu{\Mem(\Id)},n,\nil>\nst[1]\<\ceu{\Nop},n,\nil>_\Hnst\,.
    \]

  \item $p=\ceu{\EmitInt(e)}$.
    %%
    Then, by~\R{emit-int},
    \[
      \<\ceu{\EmitInt(e)},n,\nil>\nst[1]\<\ceu{\CanRun(n)},n,e>_\Hnst\,.
    \]

  \item $p=\ceu{\CanRun(n)}$.
    %%
    Then, by~\R{can-run},
    \[
      \<\ceu{\CanRun(n)},n,\nil>\nst[1]\<\ceu{\Nop},n,\nil>_\Hnst\,.
    \]

  \item $p=\ceu{\IfElse{\Mem(\Id)}{p'}{p''}}$.
    %%
    There are two subcases.
    \begin{casex}
    \item\label{thm.x.term-nst-*.if-true} $\eval(\ceu{\Mem(\Id)})$.
      %%
      Then, by~\R{if-true} and by the induction hypothesis, there is
      a~$\delta'$ such that
      \begin{align*}
        \<\ceu{\IfElse{\Mem(\Id)}{p'}{p''}},n,\nil>
        &\nst[1]\<p',n,e>\\
        &\nst[*]\delta'_\Hnst\,.
      \end{align*}
      %%
    \item$\lnot\eval(\ceu{\Mem(\Id)})$.
      %%
      Similar to Case~\ref{thm.x.term-nst-*.if-true}.
      %%
      % Then, by~\R{if-false} and by the induction hypothesis, there is
      % a~$\delta'$ such that
      % \begin{align*}
      %   \<\ceu{\IfElse{\Mem(\Id)}{p'}{p''}},n,\nil>
      %   &\nst[1]\<p'',n,e>\\
      %   &\nst[*]\delta'_\Hnst\,.
      % \end{align*}
      %%
    \end{casex}

  \item $p=\ceu{p';\,p''}$.
    %%
    There are three subcases.
    \begin{casex}
    \item\label{thm.x.term-nst-*.seq-nop} $p'=\ceu{\Nop}$.
      %%
      Then, by~\R{seq-nop} and by the induction hypothesis, there is
      a~$\delta'$ such that
      \[
        \<\ceu{\Nop;\,p''},n,\nil>
        \nst[1]\<p'',n,e>\nst[*]\delta'_\Hnst\,.
      \]
      %%
    \item\label{thm.x.term-nst-*.seq-brk} $p'=\ceu{\Break}$.
      %%
      Then, by~\R{seq-brk},
      \[
        \<\ceu{\Break;\,p''},n,\nil>\nst[1]\<\ceu{\Break},n,\nil>_\Hnst\,.
      \]
      %%
    \item\label{thm.x.term-nst-*.seq-adv}
      $p'\ne\ceu{\Nop},\ceu{\Break}$.
      %%
      Then, by the induction hypothesis, there are~$p_1'$ and~$e$ such that
      \[
        \<p',n,\nil>\nst[*]\<p_1',n,e>_\Hnst\,.
      \]
      By item~\ref{lem.x.props-nst-i.a} of Lemma~\ref{lem.x.props-nst-i},
      \begin{equation}
        \label{thm.x.term-nst-*.seq-adv.eq1}
        \<\ceu{p';\,p''},n,\nil>\nst[*]\<\ceu{p_1';\,p''},n,e>\,.
      \end{equation}
      It remains to be shown that~$\<\ceu{p_1';\,p''},n,e>$ is
      nested-irreducible.  There are four possibilities following from the
      fact that the simpler~$\<p_1',n,e>$ is nested-irreducible.
      %%
      \begin{casex}
      \item $e\ne\nil$.  Then, by the definition of~$\Hnst$,
        description~$\<\ceu{p_1';\,p''},n,e>$ is nested-irreducible.
        %%
      \item $p_1'=\ceu{\Nop}$.
        %%
        From~\eqref{thm.x.term-nst-*.seq-adv.eq1},
        \[
          \<\ceu{p';\,p''},n,\nil>\nst[*]\<\ceu{\Nop;\,p''},n,e>\,.
        \]
        From this point on, this case is similar to
        Case~\ref{thm.x.term-nst-*.seq-nop}.
        %%
      \item $p_1'=\ceu{\Break}$.
        %%
        From~\eqref{thm.x.term-nst-*.seq-adv.eq1},
        \[
          \<\ceu{p';\,p''},n,\nil>\nst[*]\<\ceu{\Break;\,p''},n,e>\,.
        \]
        From this point on, this case is similar to
        Case~\ref{thm.x.term-nst-*.seq-brk}.
        %%
      \item$\isblocked(p_1',n)$.
        %%
        Then, by definition,
        \[
          \isblocked(\ceu{p_1';p''},n)=\isblocked(p_1',n)=\mathit{true}\,.
        \]
        Hence, from~\eqref{thm.x.term-nst-*.seq-adv.eq1} and by the
        definition~$\Hnst$, description~$\<\ceu{p_1';\,p''},n,e>$ is
        nested-irreducible.
      \end{casex}
    \end{casex}

  \item\label{thm.x.term-nst-*.loop}
    $p=\ceu{\Loop{p'}}$.
    %%
    Then, by item~\ref{ass.x.syn-rest.loop} of
    Assumption~\ref{ass.x.syn-rest},
    \begin{equation}\label{thm.x.term-nst-*.loop-expd.eq1}
      \<\ceu{\Loop{p'}},n,\nil>\nst[*]\<p_1',n,e>\,,
    \end{equation}
    for some~$e$ and~$p_1'$ such that either~$p_1'=\ceu{\Break\AtLoop{p'}}$
    or~$\isblocked(p_1',n)$.
    \begin{casex}
    \item$p_1'=\ceu{\Break\AtLoop{p'}}$.
      %%
      From~\eqref{thm.x.term-nst-*.loop-expd.eq1}, by~\R{loop-brk},
      \begin{align*}
        \<\ceu{\Loop{p'}},n,\nil>
        &\nst[*]\<\ceu{\Break\AtLoop{p'}},n,e>\\
        &\nst[1]\<\ceu{\Nop},n,e>_\Hnst\,.
      \end{align*}
      %%
    \item$\isblocked(p_1',n)$.  Hence,
      from~\eqref{thm.x.term-nst-*.loop-expd.eq1} and by the definition
      of~$\Hnst$, $\<p_1',n,e>_\Hnst$.
    \end{casex}

  \item$p=\ceu{p'\AtLoop{p''}}$.
    %%
    There are three subcases.
    \begin{casex}
    \item$p'=\ceu{\Nop}$.
      %%
      Then, by~\R{loop-nop},
      \[
        \<\ceu{\Nop\AtLoop{p''}},n,\nil>
        \nst[1]\<\ceu{\Loop{p''}},n,\nil>\,.
      \]
      From this point on, this case is similar to
      Case~\ref{thm.x.term-nst-*.loop}.
      %%
    \item$p'=\ceu{\Break}$.  Then, by~\R{loop-brk},
      \[
        \<\ceu{\Break\AtLoop{p''}},n,\nil>
        \nst[1]\<\ceu{\Nop},n,\nil>_\Hnst\,.
      \]
      %%
    \item$p'\ne\ceu{\Nop},\ceu{\Break}$.  Then, by the induction hypothesis,
      there are~$p_1'$ and~$e$ such that
      \[
        \<p',n,\nil>\nst[*]\<p'_1,n,e>_\Hnst\,.
      \]
      By item~\ref{lem.x.props-nst-i.b} of Lemma~\ref{lem.x.props-nst-i},
      \[
        \<\ceu{p'\AtLoop{p''}},n,\nil>
        \nst[*]\<\ceu{p_1'\AtLoop{p''}},n,e>\,.
      \]
      It remains to be show that~$\<\ceu{p_1'\AtLoop{p''}},n,e>$ is
      nested-irreducible.  The rest of this proof is similar to that of
      Case~\ref{thm.x.term-nst-*.seq-adv}.
    \end{casex}

  \item$p=\ceu{{p'}\And{p''}}$.
    %%
    Then, by~\R{and-expd},
    \[
      \<\ceu{{p'}\And{p''}},n,\nil>
      \nst[1]\<\ceu{{p'}\AtAnd{(\CanRun(n);\,p'')}},n,\nil>\,.
    \]
    From this point on, this case is similar to
    Case~\ref{thm.x.term-nst-*.and}.
    %%
  \item\label{thm.x.term-nst-*.and}
    %%
    $p=\ceu{{p'}\AtAnd{p''}}$.
    %%
    There are two subcases.
    \begin{casex}
    \item$\lnot\isblocked(p',n)$.
      %%
      There are three subcases.
      \begin{casex}
      \item\label{thm.x.term-nst-*.and-nop1}
        $p'=\ceu{\Nop}$.
        %%
        Then, by~\R{and-nop1} and by the induction hypothesis, there
        is a~$\delta'$ such that
        \[
          \<\ceu{{\Nop}\AtAnd{p''}},n,\nil>
          \nst[1]\<p'',n,\nil>
          \nst[*]\delta'_\Hnst\,.
        \]
        %%
      \item\label{thm.x.term-nst-*.and-brk1}
        $p'=\ceu{\Break}$.
        %%
        Then, by~\R{and-brk1},
        \begin{align}
          \label{thm.x.term-nst-*.and-brk1.eq1}
          &\<\ceu{{\Break}\AtAnd{p''}},n,\nil>\\
          &\qquad\nst[1]\<\ceu{\clear(p'');\,\Break},n,\nil>\,.\notag
        \end{align}
        From~\eqref{thm.x.term-nst-*.and-brk1.eq1}, by
        item~\ref{ass.x.syn-rest.fin} of Assumption~\ref{ass.x.syn-rest}
        and by~\R{seq-nop},
        \begin{align*}
          \<\ceu{\clear(p'');\,\Break},n,\nil>
          &\nst[*]\<\ceu{\Nop;\,\Break},n,\nil>\\
          &\nst[1]\<\ceu{\Break},n,\nil>_\Hnst\,.
        \end{align*}
        %%
      \item\label{thm.x.term-nst-*.and-adv1}
        $p'\ne\ceu{\Nop},\ceu{\Break}$.
        %%
        Then, by the induction hypothesis, there are~$p_1'$ and~$e$ such
        that
        \[
          \<p',n,\nil>\nst[*]\<p_1',n,e>_\Hnst\,.
        \]
        By item~\ref{lem.x.props-nst-i.c} of Lemma~\ref{lem.x.props-nst-i},
        \[
          \<\ceu{{p'}\AtAnd{p''}},n,\nil>
          \nst[*]\<\ceu{{p_1'}\AtAnd{p''}},n,e>\,.
        \]
        It remains to be show that~$\<\ceu{{p_1'}\AtAnd{p''}},n,e>$ leads to
        an nested-irreducible description.  There are four possibilities
        following from the fact that the simpler~$\<p_1',n,e>$ is
        nested-irreducible.
        \begin{enumerate}
        \item If~$e\ne\nil$ then, by
          definition,~$\<\ceu{{p_1'}\AtAnd{p''}},n,e>_\Hnst$.
        \item If~$p_1'=\ceu{\Nop}$, this case is similar to
          Case~\ref{thm.x.term-nst-*.and-nop1}.
        \item If~$p_1'=\ceu{\Break}$, this case is similar to
          Case~\ref{thm.x.term-nst-*.and-brk1}.
        \item If~$\isblocked(p_1',n)$, this case is similar to
          Case~\ref{thm.x.term-nst-*.and2}.
        \end{enumerate}
      \end{casex}
      %%
    \item\label{thm.x.term-nst-*.and2}
      $\isblocked(p',n)$.
      %%
      There are three subcases.
      \begin{casex}
      \item\label{thm.x.term-nst-*.and-nop2}
        $p''=\ceu{\Nop}$.
        %%
        Then, by~\R{and-nop2},
        \[
          \<\ceu{{p'}\AtAnd{\Nop}},n,\nil>\nst[1]\<p',n,\nil>_\Hnst\,.
        \]
        %%
      \item\label{thm.x.term-nst-*.and-brk2}
        $p''=\ceu{\Break}$.
        %%
        Then, by~\R{and-brk2},
        \[
          \<\ceu{{p'}\AtAnd{\Break}},n,\nil>
          \nst[1]\<\ceu{\clear(p');\,\Break},n,\nil>\,.
        \]
        From this point on, this case is similar to
        Case~\ref{thm.x.term-nst-*.and-brk1}.
        %%
      \item\label{thm.x.term-nst-*.and-adv2}
        $p''\ne\ceu{\Nop},\ceu{\Break}$.
        %%
        Then, by the induction hypothesis, there are~$p_1''$ and~$e$ such
        that
        \[
          \<p'',n,\nil>\nst[*]\<p_1'',n,e>_\Hnst\,.
        \]
        By item~\ref{lem.x.props-nst-i.e} of Lemma~\ref{lem.x.props-nst-i},
        \[
          \<\ceu{{p'}\AtAnd{p''}},n,\nil>
          \nst[*]\<\ceu{{p'}\AtAnd{p_1''}},n,e>\,.
        \]
        It remains to be show that~$\<\ceu{{p'}\AtAnd{p_1''}},n,e>$ leads to
        an nested-irreducible description.  There are four possibilities
        following from the fact that the simpler~$\<p_1'',n,e>$ is
        nested-irreducible.
        \begin{enumerate}
        \item If~$e\ne\nil$ then, by definition,
          $\<\ceu{{p'}\AtAnd{p_1''}},n,e>_\Hnst$.
        \item If~$p_1''=\ceu{\Nop}$, this case is similar to
          Case~\ref{thm.x.term-nst-*.and-nop2}.
        \item If~$p_1''=\ceu{\Break}$, this case is similar to
          Case~\ref{thm.x.term-nst-*.and-brk2}.
        \item If~$\isblocked(p_1'',n)$ then, as both sides are blocked, by
          definition, $\<\ceu{{p'}\AtAnd{p_1''}},n,e>_\Hnst$.
        \end{enumerate}
      \end{casex}
    \end{casex}

  \item$p=\ceu{{p'}\Or{p''}}$.
    %%
    Then, by~\R{or-expd},
    \[
      \<\ceu{{p'}\Or{p''}},n,\nil>
      \nst[1]\<\ceu{{p'}\AtOr{(\CanRun(n);\,p'')}},n,\nil>\,.
    \]
    From this point on, this case is similar to
    Case~\ref{thm.x.term-nst-*.or}.

  \item\label{thm.x.term-nst-*.or}
    $p=\ceu{{p'}\AtOr{p''}}$.
    %%
    There are two subcases.
    \begin{casex}
    \item$\lnot\isblocked(p',n)$.
      %%
      There are three subcases.
      \begin{casex}
      \item\label{thm.x.term-nst-*.or-nop1} $p'=\ceu{\Nop}$.  Then,
        by~\R{or-nop1},
        \begin{equation}
          \label{thm.x.term-nst-*.or-nop1.eq1}
          \<\ceu{{\Nop}\AtOr{p''}},n,\nil>
          \nst[1]\<\ceu{\clear(p'')},n,\nil>\,.
        \end{equation}
        From~\eqref{thm.x.term-nst-*.or-nop1.eq1}, by
        item~\ref{ass.x.syn-rest.fin} Assumption~\ref{ass.x.syn-rest},
        \[
          \<\ceu{\clear(p'')},n,\nil>\nst[*]\<\ceu{\Nop},n,\nil>_\Hnst\,.
        \]
        %%
      \item\label{thm.x.term-nst-*.or-brk1}
        $p'=\ceu{\Break}$.
        %%
        Similar to Case~\ref{thm.x.term-nst-*.and-brk1}.
        %%
      \item$p'\ne\ceu{\Nop},\ceu{\Break}$.
        %%
        Similar to Case~\ref{thm.x.term-nst-*.and-adv1}.
      \end{casex}
      %%
    \item\label{thm.x.term-nst-*.or-adv1}$\isblocked(p',n)$.
      %%
      There are three subcases.
      \begin{casex}
      \item$p''=\ceu{\Nop}$.
        %%
        Then, by~\R{or-nop2},
        \begin{equation}
          \label{thm.x.term-nst-*.or-nop2.eq1}
          \<\ceu{p'\AtOr{\Nop}},n,\nil>
          \nst[1]\<\clear(p'),n,\nil>\,.
        \end{equation}
        From~\eqref{thm.x.term-nst-*.or-nop2.eq1}, by
        item~\ref{ass.x.syn-rest.fin} of Assumption~\ref{ass.x.syn-rest} and
        by definition of~$\clear$,
        \[
          \<\ceu{\clear(p')},n,\nil>\nst[*]\<\ceu{\Nop},n,\nil>_\Hnst\,.
        \]
        %%
      \item$p''=\ceu{\Break}$.
        %%
        Similar to Case~\ref{thm.x.term-nst-*.and-brk2}.
        %%
      \item$p''\ne\ceu{\Nop},\ceu{\Break}$.
        %%
        Similar to Case~\ref{thm.x.term-nst-*.and-adv2}.\qedhere
      \end{casex}
    \end{casex}
  \end{casex}
\end{proof}


\begin{lemma}\strut
  \label{lem.rank-out}
  %%
  \begin{enumerate:a}
  \item\label{lem.rank-out-push} If~$\delta\outpush\delta'$
    then~$\rank(\delta)=\rank(\delta')$.
  \item\label{lem.rank-out-pop} If~$\delta\outpop\delta'$
    then~$\rank(\delta)>\rank(\delta')$.
  \end{enumerate:a}
\end{lemma}
\begin{proof}\strut
  Let~$\delta=\<p,n,e>$, $\delta'=\<p',n',e'>$,
  $\rank(\delta)=\<i,j>$, and~$\rank(\delta')=\<i',j'>$.
  \begin{enumerate:a}
  \item Suppose~$\<p,n,e>\outpush\<p',n',e'>$.  Then, by~\R{push},
    $e\ne\nil$, $p'=\bcast(p,e)$, $n'=n+1$, and~$e'=\nil$.  By
    Definition~\ref{def.rank}, $j=n+1$, as~$e\ne\nil$, and~$j'=n+1$,
    as~$e'=\nil$ and~$n'=n+1$; hence~$j=j'$.
    %%
    It remains to be shown that~$i=i'$:
    \begin{align*}
      i&=\pot(p,e)
         \tag*{by Definition~\ref{def.rank}}\\
       &=\pot'(\bcast(p,e))
         \tag*{by Definition~\ref{def.pot}}\\
       &=\pot'(p')
         \tag*{since~$p'=\bcast(p,e)$}\\
       &=\pot'(\bcast(p',\nil))
         \tag*{by definition of~$\bcast$}\\
       &=\pot'(\bcast(p',e'))
         \tag*{since~$e'=\nil$}\\
       &=\pot(p',e')
         \tag*{by Definition~\ref{def.pot}}\\
       &=i'
         \tag*{by Definition~\ref{def.rank}}
    \end{align*}
    Therefore, $\<i,j>=\<i',j'>$.

  \item Suppose~$\<p,n,e>\outpop\<p',n',e'>$.  Then, by~\R{pop}, $p=p'$,
    $n>0$, $n'=n-1$, and~$e=e'=\nil$.
    %%
    By Definition~\ref{def.pot}, $\pot(\bcast(p,e))=\pot(\bcast(p',e'))$;
    hence~$i=i'$.  And by Definition~\ref{def.rank}, $j=n$, as~$e=\nil$,
    and~$j'=n-1$, as~$e'=\nil$ and~$n'=n-1$; hence~$j>j'$.
    Therefore,~${\<i,j>}>{\<i',j'>}$.\qedhere
  \end{enumerate:a}
\end{proof}


\begin{lemma}
  \label{lem.rank-nst}
  %%
  If~$\delta\nst\delta'$ then~$\rank(\delta)\ge\rank(\delta')$.
\end{lemma}
\begin{proof}
  We proceed by induction on the structure of~$\nst$ derivations.
  Let~$\delta=\<p,n,e>$, $\delta'=\<p',n',e'>$, $\rank(\delta)=\<i,j>$,
  and~$\rank(\delta')=\<i',j'>$.  By the hypothesis of the lemma, there is
  a derivation~$\pi$ such that
  \[
    \pi\Vdash\<p,n,e>\nst\<p',n',e'>\,.
  \]
  By definition of~$\nst$, $e=\nil$ and $n=n'$.  Depending on the structure
  of program~$p$, there are~11 possibilities.  In each one of them, we show
  that~$\rank(\delta)\ge\rank(\delta')$.

  \begin{case}
    $p=\ceu{\Mem(id)}$.
    %%
    Then~$\pi$ is an instance of~\R{mem}.  Hence~$p'=\ceu{\Nop}$
    and~$e'=\nil$.  Thus $\rank(\delta)=\rank(\delta')=\<0,n>$.
  \end{case}

  \begin{case}
    $p=\ceu{\EmitInt(e_1)}$.
    %%
    Then~$\pi$ is an instance of~\R{emit-int}.  Hence~$p'=\ceu{\CanRun}$
    and~$e'=e_1\ne\nil$.
    Thus
    \[
      {\rank(\delta)={\<1,n>}}>{\<0,n+1>=\rank(\delta')}\,.
    \]
  \end{case}

  \begin{case}
    $p=\ceu{\CanRun(n)}$.
    %%
    Then~$\pi$ is an instance of~\R{can-run}.  Hence~$p'=\ceu{\Nop}$
    and~$e'=\nil$.  Thus
    \[
      \rank(\delta)=\rank(\delta')=\<0,n>\,.
    \]
  \end{case}

  \begin{case}
    $p=\ceu{\IfElse{p}{p_1}{p_2}}$.
    %%
    There are two subcases.
    \begin{subcase}
      \label{lem.rank-nst.if-true}
      $\eval(\ceu{\Mem(\Id)})$~is true.
      %%
      Then~$\pi$ is an instance of~\R{if-true}.  Hence~$p'=\ceu{p_1}$
      and~$e'=\nil$.  Thus
      \begin{align*}
        \rank(\delta)&=\<\max\{pot'(p_1),pot'(p_2)\},n>\\
                     &\ge\<\pot'(p_1),n>=\rank(\delta')\,.
      \end{align*}
    \end{subcase}
    \begin{subcase}
      $\eval(\ceu{\Mem(\Id)})$~is false.
      %%
      Similar to Case~\ref{lem.rank-nst.if-true}.
    \end{subcase}
  \end{case}

  \begin{case}
    $p=\ceu{p_1;\,p_2}$.
    %%
    There are three subcases.
    \begin{subcase}
      \label{lem.rank-nst.seq-nop}
      $p_1=\ceu{\Nop}$.
      %%
      Then~$\pi$ is an instance of~\R{seq-nop}.
      Hence~$p'=p_2$ and~$e'=\nil$.  Thus
      \begin{align*}
        \rank(\delta)&=\<\pot'(p_1)+\pot'(p_2),n>\\
                     &\ge\<pot'(p_2),n>=\rank(\delta')\,.
      \end{align*}
    \end{subcase}
    \begin{subcase}
      \label{lem.rank-nst.seq-brk}
      $p_1=\ceu{\Break}$.
      %%
      Then~$\pi$ is an instance of~\R{seq-brk}.
      Hence~$p'=p_1$ and~$e'=\nil$.  Thus
      \[
        \rank(\delta)=\rank(\delta')=\<0,n>\,.
      \]
    \end{subcase}
    \begin{subcase}
      \label{lem.rank-nst.seq-adv}
      $p_1\ne\ceu{\Nop},\ceu{\Break}$.
      %%
      Then~$\pi$ is an instance of~\R{seq-adv}.  Hence there is a
      derivation~$\pi'$ such that
      \[
        \pi'\Vdash\<p_1,n,\nil>\nst\<p_1',n,e_1'>\,,
      \]
      for some~$p_1'$ and~$e_1'$.  Thus~$p'=p_1';p_2$ and~$e'=e_1'$.  By the
      induction hypothesis,
      \begin{equation}
        \label{lem.rank-nst.seq-adv.eq1}
        \rank(\<p_1,n,\nil>)\ge\rank(\<p_1',n,e_1'>)\,.
      \end{equation}
      There are two subcases.
      \begin{subsubcase}
        $e'=\nil$.
        %%
        Then
        \begin{align*}
          \rank(\delta)&=\<\pot'(p_1)+\pot'(p_2),n>\enspace\text{and}\\
          \rank(\delta')&=\<\pot'(p_1')+\pot'(p_2),n>\,.
        \end{align*}
        By~\eqref{lem.rank-nst.seq-adv.eq1}, $\pot'(p_1)\ge\pot'(p_1')$.
        Thus
        \[
          \rank(\delta)\ge\rank(\delta')\,.
        \]
      \end{subsubcase}
      \begin{subsubcase}
        $e'\ne\nil$.
        %%
        Then~$\pi'$ contains one application of~\R{emit-int}, which consumes
        one~$\ceu{\EmitInt(e')}$ expression from~$p_1$ and implies
        $\pot'(p_1)>\pot'(p_1')$.  Thus
        \begin{align*}
          \rank(\delta)&=\<\pot'(p_1)+\pot'(p_2),n>\\
                       &>\<\pot'(p_1')+\pot'(p_2),n+1>=\rank(\delta')\,.
        \end{align*}
      \end{subsubcase}
    \end{subcase}
  \end{case}

  \begin{case}
    \label{lem.rank-nst.loop-expd}
    $p=\ceu{\Loop{p_1}}$.
    %%
    Then~$\pi$ is an instance of~\R{loop-expd}.
    Hence~$p'=\ceu{p_1\AtLoop{p_1}}$ and~$e'=\nil$.
    %%
    By item~\eqref{ass.syn-rest.loop} of Assumption~\ref{ass.syn-rest}, all
    execution paths of~$p_1$ contain at least one occurrence
    of~$\ceu{\Break}$ or~$\ceu{\AwaitExt}$.  Thus, by condition~(\dag) in
    Definition~\ref{def.pot},
    \[
      \rank(\delta)=\rank(\delta')=\<\pot'(p_1),n>\,.
    \]
  \end{case}

  \begin{case}
    $p=\ceu{{p_1}\AtLoop{p_2}}$.
    %%
    There are three cases.
    \begin{subcase}
      $p_1=\ceu{\Nop}$.
      %%
      Similar to Case~\ref{lem.rank-nst.seq-nop}.
    \end{subcase}
    \begin{subcase}
      $p_1=\ceu{\Break}$.
      %%
      Similar to Case~\ref{lem.rank-nst.seq-brk}.
    \end{subcase}
    \begin{subcase}
      \label{lem.rank-nst.loop-adv}
      $p_1\ne\ceu{\Nop},\ceu{\Break}$.
      %%
      Then~$\pi$ is an instance of~\R{loop-adv}.  Hence there is a
      derivation~$\pi'$ such that
      \[
        \pi'\Vdash\<p_1,n,\nil>\nst\<p_1',n,e_1'>\,,
      \]
      for some~$p_1'$ and~$e_1'$.  Thus~$p'=\ceu{p_1'\AtLoop{\,p_2}}$
      and~$e'=e_1'$.
      %%
      % By the induction hypothesis,
      % \begin{equation}
      %   \label{lem.rank-nst.loop-adv-eq1}
      %   \rank(\<p_1,n,\nil>)\ge\rank(\<p_1',n,e_1'>)\,.
      % \end{equation}
      %%
      There are two subcases.
      \begin{subsubcase}
        $\pot'(p)=\pot'(p_1)$.
        %%
        Then every execution path of~$p_1$ contains a~$\ceu{\Break}$
        or~$\ceu{\AwaitExt}$ expression.  A single~$\nst$ cannot terminate
        the loop, since~$p_1\ne\ceu{\Break}$, nor can it consume
        an~$\ceu{\AwaitExt}$, which means that all execution paths in~$p_1'$
        still contain a~$\ceu{\Break}$ or~$\ceu{\AwaitExt}$.
        Hence~$\pot'(p')=\pot'(p_1')$.  The rest of this proof is similar to
        that of Case~\ref{lem.rank-nst.seq-adv}.
      \end{subsubcase}
      \begin{subsubcase}
        $\pot'(p)=\pot'(p_1)+\pot'(p_2)$.
        %%
        Then some execution path in~$p_1$ does not contain a~$\ceu{\Break}$
        or~$\ceu{\AwaitExt}$ expression.  Since~$p_1\ne\ceu{\Nop}$, a
        single~$\nst$ cannot restart the loop, which means that~$p_1'$ still
        contain some execution path in which a~$\ceu{\Break}$
        or~$\ceu{\AwaitExt}$ does not occur.
        Hence~$\pot'(p')=\pot'(p_1')+\pot'(p_2)$.  The rest of this proof is
        similar to that of Case~\ref{lem.rank-nst.seq-adv}.
      \end{subsubcase}
    \end{subcase}
  \end{case}

  \begin{case}
    \label{lem.rank-nst.and-expd}
    $p=\ceu{{p_1}\And{p_2}}$.
    %%
    Then~$\pi$ is an instance of~\R{and-expd}.
    Hence~$p'=\ceu{{p_1}\AtAnd(\CanRun(n);\,p_2)}$ and~$e'=\nil$.
    Thus
    \[
      \rank(\delta)=\rank(\delta')=\<\pot'(p_1)+\pot'(p_2),n>\,.
    \]
  \end{case}

  \begin{case}
    \label{lem.rank-nst.and}
    $p=\ceu{{p_1}\AtAnd{p_2}}$.
    %%
    There are two subcases.
    \begin{subcase}
      \label{lem.rank-nst.and1}
      $\isblocked(p_1,n)$~is false.
      %%
      There are three subcases.
      \begin{subsubcase}
        \label{lem.rank-nst.and-nop1}
        $p_1=\ceu{\Nop}$.
        %%
        Then~$\pi$ is an instance of~\R{and-nop1}.  Hence~$p'=p_2$
        and~$e'=\nil$.  Thus
        \[
          \rank(\delta)=\rank(\delta')=\<0+\pot'(p_2),n>\,.
        \]
      \end{subsubcase}
      \begin{subsubcase}
        \label{lem.rank-nst.and-brk1}
        $p_1=\ceu{\Break}$.
        %%
        Then~$\pi$ is an instance of~\R{and-brk1}.
        Hence~$p'=\ceu{\clear(p_2);\,\Break}$ and~$e'=\nil$.  By item
        \eqref{ass.syn-rest.fin} of Assumption~\ref{ass.syn-rest} and by the
        definition of~$\clear$, $\clear(p_2)$ does not
        contain~$\ceu{\EmitInt}$ expressions.  Thus
        \[
          \rank(\delta)=\rank(\delta')=\<0,n>\,.
        \]
      \end{subsubcase}
      \begin{subsubcase}
        \label{lem.rank-nst.and-adv1}
        $p_1\ne\ceu{\Nop},\ceu{\Break}$.
        %%
        Then~$\pi$ is an instance of~\R{and-adv1}.  As~$p_1\ne\ceu{\Break}$
        and~$p_2\ne\ceu{\Break}$ (otherwise~\R{and-brk2} would have taken
        precedence), the rest of this proof is similar to that of
        Case~\ref{lem.rank-nst.seq-adv}.
      \end{subsubcase}
    \end{subcase}
    \begin{subcase}
      $\isblocked(p_1,n)$~is true.
      %%
      Similar to Case~\ref{lem.rank-nst.and1}
    \end{subcase}
  \end{case}

  \begin{case}
    $p=\ceu{{p_1}\Or{p_2}}$.
    %%
    Then~$\pi$ is an instance of~\R{or-expd}.
    Hence~$p'=\ceu{{p_1}\AtOr(\CanRun(n);\,p_2)}$ and~$e'=\nil$.
    Thus
    \[
      \rank(\delta)=\rank(\delta')=\<\pot'(p_1)+\pot'(p_2),n>\,.
    \]
  \end{case}

  \begin{case}
    $p=\ceu{{p_1}\AtOr{p_2}}$.
    %%
    There are two subcases.
    \begin{subcase}
      \label{lem.rank-nst.or1}
      $\isblocked(p_1,n)$ is false.
      %%
      There are three subcases.
      \begin{subsubcase}
        $p_1=\ceu{\Nop}$.
        %%
        Then~$\pi$ is an instance of~\R{or-nop1}.  Hence~$p'=\clear(p_2)$
        and~$e'=\nil$.  By item \eqref{ass.syn-rest.fin} of
        Assumption~\ref{ass.syn-rest} and by the definition of~$\clear$,
        $p'$ does not contain~$\ceu{\EmitInt}$ expressions.  Thus
        \[
          \rank(\delta)=\rank(\delta')=\<0,n>\,.
        \]
      \end{subsubcase}
      \begin{subsubcase}
        $p_1=\ceu{\Break}$.
        %%
        Similar to Case~\ref{lem.rank-nst.and-brk1}.
      \end{subsubcase}
      \begin{subsubcase}
        $p_1\ne\ceu{\Nop},\ceu{\Break}$.
        %%
        Similar to Case~\ref{lem.rank-nst.and-adv1}.
      \end{subsubcase}
    \end{subcase}
    \begin{subcase}
      $\isblocked(p_1,n)$ is true.
      %%
      Similar to Case~\ref{lem.rank-nst.or1}.\qedhere
    \end{subcase}
  \end{case}
\end{proof}


\begin{theorem}
  \label{thm.rank-nst-*}
  %%
  If~$\delta\nst[*]\delta'$ then~$\rank(\delta)\ge\rank(\delta')$.
\end{theorem}
\begin{proof}
  If~$\delta\nst[*]\delta'$ then~$\delta\nst[i]\delta'$, for some~$i$.  We
  proceed by induction on~$i$.
  %%
  The theorem is trivially true for~$i=0$ and follows directly from
  Lemma~\ref{lem.rank-nst} for~$i=1$.  Suppose
  $\delta\nst[1]\delta_1'\nst[i-1]\delta'$, for some~$i>1$ and~$\delta_1'$.
  Thus, by Lemma~\ref{lem.rank-nst} and by the induction hypothesis,
  \[
    \rank(\delta)\ge\rank(\delta_1')\ge\rank(\delta')\,.\qedhere
  \]
\end{proof}


\begin{theorem}[Termination]\label{thm.term}\strut\\
  %%
  For any~$\delta$, there is a~$\delta'_\#$ such
  that~$\delta\trans[*]\delta'_\#$.
\end{theorem}
\begin{proof}
  By lexicographic induction on~$rank(\delta)$.  Let~$\delta=\<p,n,e>$ and
  $\rank(\delta)=\<i,j>$.
  %%
  \begin{basis}
    If~$\<i,j>=\<0,0>$ then~$\delta$ cannot be advanced by~$\out$, as~$j=0$
    implies~$e=\nil$ and~$n=0$ (neither~\R{push} nor~\R{pop} can be
    applied).  There are two possibilities:  either~$\delta$ is
    nested-irreducible or it is not.  In the first case, the theorem is
    trivially true, as~$\delta\nst[0]\delta_\Hnst$.  Suppose~$\delta$ is not
    nested-irreducible.  Then, by Theorem~\ref{thm.x.term-nst-*},
    $\delta\nst[*]\delta'_\Hnst$ for some~$\delta'_\Hnst$.  By
    Theorem~\ref{thm.rank-nst-*},
    \[
      \<i,j>=\<0,0>\ge\rank(\delta')\,,
    \]
    which implies~$\rank(\delta')=\<0,0>$.
  \end{basis}
  \begin{induction}
    Let~$\<i,j>\ne\<0,0>$.
    %%
    There are two subcases.
    \begin{case}
      \label{thm.term.Hnst}
      $\delta$~is nested-irreducible.
      %%
      There are two cases.
      \begin{subcase}
        \label{thm.term.Hnst-j0}
        $j=0$.  By Definition~\ref{def.H}, $\delta_\#$.
        Thus~$\delta\trans[0]\delta_\#$.
      \end{subcase}
      \begin{subcase}
        \label{thm.term.Hnst-j>0}
        $j>0$.
        %%
        There are two subcases.
        \begin{subsubcase}
          \label{thm.term.Hnst-j>0-nonnil}
          $e\ne\nil$.
          %%
          Then, by~\R{out} and by Theorem~\ref{thm.x.term-nst-*}, there
          are~$\delta_1'$ and~$\delta'_\Hnst=\<p',n+1,e'>$ such that
          \[
            \delta\outpush\delta_1'\nst[*]\delta'_\Hnst\,.
          \]
          Thus, by item~\eqref{lem.rank-out-push} of
          Lemma~\ref{lem.rank-out} and by Theorem~\ref{thm.rank-nst-*},
          \begin{align*}
            \rank(\delta)=\rank(\delta_1')&=\<i,j>\\
                                          &\ge\rank(\delta')=\<i',j'>\,.
          \end{align*}
          If~$e'=\nil$, then $i=i'$ and~$j=j'$, and the rest of this proof
          is similar to that of Case~\ref{thm.term.Hnst-j>0-nil}.
          Otherwise, if~$e'\ne\nil$ then $i>i'$, since
          an~$\ceu{\EmitInt(e')}$ was consumed by the nested transitions.
          Thus,
          \[
            \rank(\delta)>\rank(\delta')\,.
          \]
          By the induction hypothesis, $\delta'\trans[*]\delta''_\#$, for
          some~$\delta''_\#$.  Therefore, $\delta\trans[*]\delta''_\#$.
        \end{subsubcase}
        \begin{subsubcase}
          \label{thm.term.Hnst-j>0-nil}
          $e=\nil$.
          %%
          Then, since~$j>0$, $\delta\outpop\delta'$, for
          some~$\delta''$.  By item~\eqref{lem.rank-out-pop} of
          Lemma~\ref{lem.rank-out},
          \[
            \rank(\delta)>\rank(\delta')\,.
          \]
          Hence, by the induction hypothesis, there is a~$\delta''_\#$ such
          that~$\delta'\trans[*]\delta''_\#$.
          Therefore, $\delta\trans[*]\delta''_\#$.
        \end{subsubcase}
      \end{subcase}
    \end{case}
    \begin{case}
      $\delta$~is not nested-irreducible.
      %%
      Then~$e=\nil$ and, by Theorems~\ref{thm.x.term-nst-*}
      and~\ref{thm.rank-nst-*}, there is a~$\delta'_\Hnst$ such
      that~$\delta\nst[*]\delta'_\Hnst$
      with~$\rank(\delta)\ge\rank(\delta'_\Hnst)$.  The rest of this proof
      is similar to that of Case~\ref{thm.term.Hnst}.\qedhere
    \end{case}
  \end{induction}
\end{proof}
